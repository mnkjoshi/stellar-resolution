import{bf as z,bh as K,jw as B,aP as H,au as S,b1 as J,s as b,bI as P,jx as Q,b8 as Z,D as V,dL as U,jy as X,a2 as Y,bm as ee,jz as te,jA as W,jB as ne,cO as O,dh as _,at as re,dQ as L,hx as I,jC as D,cM as ae,gC as oe,jD as se,eh as ie,jE as le}from"./index-BCRx-hwS.js";import{s as ce}from"./featurePopupQueryUtils-BOCsP5Ld.js";import{D as ue,C as fe}from"./I3SBinaryReader-DiiuzW9f.js";function de(e,t,n,r,a){const o=n==="east-north-up"?z(e):he(e,t,r),i=K();return B(r,o,i,a),i}const F=1,A=5-F;function he(e,t,n){const r=S(),a=e[3],o=2**(Math.ceil(Math.log(a)*Math.LOG2E/A)*A+F);if(n.isGeographic){const l=o/H(n).radius*180/Math.PI,h=Math.round(e[1]/l),y=Math.max(-90,Math.min(90,h*l)),u=l/Math.cos((Math.abs(y)-l/2)/180*Math.PI),p=Math.round(e[0]/u)*u;r[0]=p,r[1]=y}else{const l=Math.round(e[0]/o),h=Math.round(e[1]/o);r[0]=l*o,r[1]=h*o}const i=e[2]+t,c=Math.round(i/o);return r[2]=c*o,r}function q(e){return e?parseInt(e.slice(e.lastIndexOf("/")+1),10):void 0}function Ue(e){var t;if(Z("disable-feature:i3s-draco")||!e)return!1;for(const n of e)for(const r of n.geometryBuffers)if(((t=r.compressedAttributes)==null?void 0:t.encoding)==="draco")return!0;return!1}function We(e,t,n,r){n.traverse(t,a=>{const o=a.serviceMbsInIndexSR;return(o!=null&&pe(e,o))!==w.OUTSIDE&&(r(a),!0)})}function _e(e,t,n){let r=0,a=0;for(let o=0;o<t.length&&r<e.length;o++)e[r]===t[o]&&(n(o)&&(e[a]=e[r],a++),r++);e.length=a}function Le(e,t,n){let r=0,a=0;for(;r<n.length;)Q(e,n[r])>=0===t&&(n[a]=n[r],a++),r++;n.length=a}function Ae(e,t){if(t.rotationScale[1]===0&&t.rotationScale[2]===0&&t.rotationScale[3]===0&&t.rotationScale[5]===0&&t.rotationScale[6]===0&&t.rotationScale[7]===0)return M[0]=(e[0]-t.position[0])/t.rotationScale[0],M[1]=(e[1]-t.position[1])/t.rotationScale[4],M[2]=(e[2]-t.position[0])/t.rotationScale[0],M[3]=(e[3]-t.position[1])/t.rotationScale[4],M}const M=O();var w;function pe(e,t){const n=t[0],r=t[1],a=t[3],o=e[0]-n,i=n-e[2],c=e[1]-r,l=r-e[3],h=Math.max(o,i,0),y=Math.max(c,l,0),u=h*h+y*y;return u>a*a?w.OUTSIDE:u>0?w.INTERSECTS_CENTER_OUTSIDE:-Math.max(o,i,c,l)>a?w.INSIDE:w.INTERSECTS_CENTER_INSIDE}function ye(e,t,n){const r=[],a=n==null?void 0:n.missingFields,o=n==null?void 0:n.originalFields;let i=!1;for(const c of e){const l=t.get(c);l?(o==null||o.push(c),r.push(l.name),c!==l.name&&(i=!0)):a==null||a.push(c)}return n&&"hasMismatchedCasing"in n&&(n.hasMismatchedCasing=i),r}async function je(e,t,n,r,a,o){if(t.length===0)return[];const i=e.attributeStorageInfo;if(e.associatedLayer!=null)try{return await Se(e.associatedLayer,t,r,o)}catch(c){if(e.associatedLayer.loaded)throw c}if(i){const c=me(e,t,n,a),l=e.parsedUrl.path;return await Promise.allSettled(c.map(h=>be(l,i,h.node,h.indices,r,e.apiKey,e.customParameters,o).then(y=>{for(let u=0;u<h.graphics.length;u++){const p=h.graphics[u],g=y[u];if(p.attributes)for(const s in p.attributes)s in g||(g[s]=p.attributes[s]);p.attributes=g}}))),t}throw new b("scenelayer:no-attribute-source","This scene layer does not have a source for attributes available")}function me({globalIdField:e},t,n,r){var c;const a=new Map,o=[],i=r();for(const l of t){const h=(c=l.attributes)==null?void 0:c[n],y=h==null?l.getGlobalId():void 0;for(let u=0;u<i.length;u++){const p=i[u],g=ge(p,h,e,y);if(g<0)continue;let s=a.get(p.node);s||(s={node:p.node,indices:[],graphics:[]},o.push(s),a.set(p.node,s)),s.indices.push(g),s.graphics.push(l);for(let f=u;f>0;f--)i[f]=i[f-1];i[0]=p;break}}return o}function ge(e,t,n,r){var o,i;if(t!=null&&typeof t=="number")return e.featureIds.indexOf(t);if(r==null||n==null)return-1;const a=(i=(o=e.attributeInfo)==null?void 0:o.attributeData)==null?void 0:i[n];return a?a.indexOf(r):-1}async function Se(e,t,n,r){const a=[],o={hasMismatchedCasing:!1,originalFields:a},i=ye(n,e.fieldsIndex,o),c=new Y({outFields:[...i]});if(await ce(e,t,c,{updateSourceAttributes:!0,...r}),!o.hasMismatchedCasing)return t;for(let l=0;l<t.length;l++){const h=t[l];if(h.attributes)for(let y=0;y<a.length;y++){const u=a[y],p=i[y];p in h.attributes&&(h.attributes[u]=h.attributes[p],delete h.attributes[p])}}return t}function be(e,t,n,r,a,o,i,c){return we(e,t,n.resources.attributes,r,a,o,i,c)}async function we(e,t,n,r,a,o,i,c){const l=[];for(const u of t)if(u&&a.includes(u.name)){const p=`${e}/nodes/${n}/attributes/${u.key}/0`;l.push({url:p,storageInfo:u})}const h=await Promise.allSettled(l.map(u=>J(u.url,{responseType:"array-buffer",query:{...i,token:o},signal:c==null?void 0:c.signal}).then(p=>ue(u.storageInfo,p.data)))),y=[];for(const u of r){const p={};for(let g=0;g<h.length;g++){const s=h[g];if(s.status==="fulfilled"){const f=s.value;p[l[g].storageInfo.name]=fe(f,u)}}y.push(p)}return y}function Ie(e){const t=e.store,n=t.indexCRS||t.geographicCRS,r=n===void 0?t.indexWKT:void 0;if(r){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-index-and-no-layer-spatial-reference","Found indexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-index-incompatible","The indexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new P(q(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function Me(e){const t=e.store,n=t.vertexCRS||t.projectedCRS,r=n===void 0?t.vertexWKT:void 0;if(r){if(!e.spatialReference)throw new b("layerview:no-store-spatial-reference-wkt-vertex-and-no-layer-spatial-reference","Found vertexWKT in the scene layer store but no layer spatial reference",{});if(r!==e.spatialReference.wkt)throw new b("layerview:store-spatial-reference-wkt-vertex-incompatible","The vertexWKT of the scene layer store does not match the WKT of the layer spatial reference",{})}const a=n?new P(q(n)):e.spatialReference;return a.equals(e.spatialReference)?e.spatialReference:a}function k(e,t,n){if(!V(e,t))throw U("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid);if(n==="local"&&!Te(e,t))throw U("scene layer",e==null?void 0:e.wkid,t==null?void 0:t.wkid)}function Ge(e,t,n){var r,a,o,i;if(((r=e.serviceUpdateTimeStamp)==null?void 0:r.lastUpdate)!==((a=t.serviceUpdateTimeStamp)==null?void 0:a.lastUpdate)||!n.isEmpty||((o=e.associatedLayer)==null?void 0:o.url)!==((i=t.associatedLayer)==null?void 0:i.url))throw new b("layerview:recycle-failed","Could not recycle layerview")}function Te(e,t){return e.equals(t)||e.isWGS84&&t.isWebMercator||e.isWebMercator&&t.isWGS84}function Ee(e,t,n){const r=Ie(e),a=Me(e);k(r,t,n),k(a,t,n)}function xe(e){var t;return(e.geometryType==null||e.geometryType==="triangles")&&(e.topology==null||e.topology==="PerAttributeArray")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function Ke(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!xe(e.store.defaultGeometrySchema))throw new b("scenelayer:unsupported-geometry-schema","The geometry schema of this scene layer is not supported.",{url:e.parsedUrl.path})}function Pe(e,t){Ee(e,t.spatialReference,t.viewingMode)}function ve(e){var t;return e.geometryType!=null&&e.geometryType==="points"&&(e.topology==null||e.topology==="PerAttributeArray")&&(e.encoding==null||e.encoding===""||e.encoding==="lepcc-xyz")&&((t=e.vertexAttributes)==null?void 0:t.position)!=null}function Fe(e){var t;if(((t=e.store)==null?void 0:t.defaultGeometrySchema)==null||!ve(e.store.defaultGeometrySchema))throw new b("pointcloud:unsupported-geometry-schema","The geometry schema of this point cloud scene layer is not supported.",{})}function qe(e,t){k(e.spatialReference,t.spatialReference,t.viewingMode)}function Re(e){return e.type==="simple"||e.type==="class-breaks"||e.type==="unique-value"}function $e(e){return e.type==="mesh-3d"}function ze(e){var n;if(e==null||!Re(e)||(e.type==="unique-value"||e.type==="class-breaks")&&e.defaultSymbol==null)return!0;const t=e.symbols;if(t.length===0)return!0;for(const r of t){if(!$e(r)||r.symbolLayers.length===0)return!0;for(const a of r.symbolLayers.items)if(a.type!=="fill"||((n=a.material)==null?void 0:n.color)==null||a.material.colorMixMode!=="replace")return!0}return!1}(function(e){e[e.OUTSIDE=0]="OUTSIDE",e[e.INTERSECTS_CENTER_OUTSIDE=1]="INTERSECTS_CENTER_OUTSIDE",e[e.INTERSECTS_CENTER_INSIDE=2]="INTERSECTS_CENTER_INSIDE",e[e.INSIDE=3]="INSIDE"})(w||(w={}));const Be=X({color:[0,0,0,0],opacity:0});class Ce{constructor(){this.edgeMaterial=null,this.material=null,this.castShadows=!0}}function He(e){const t=new Ce;let n=!1,r=!1;for(const a of e.symbolLayers.items)if(a.type==="fill"&&a.enabled){const o=a.material,i=a.edges;if(o!=null&&!n){const c=o.color,l=te(o.colorMixMode);t.material=c!=null?{color:[c.r/255,c.g/255,c.b/255],alpha:c.a,colorMixMode:l}:{color:[1,1,1],alpha:1,colorMixMode:W.Multiply},t.castShadows=a.castShadows,n=!0}i==null||r||(t.edgeMaterial=ne(i,{}),r=!0)}return t.material||(t.material={color:[1,1,1],alpha:1,colorMixMode:W.Multiply}),t}function Je(e,t){return(0|e)+(0|t)|0}function Qe(e,t,n,r,a,o,i){if(!o||o.length===0||t==null||!e.serviceMbsInIndexSR)return null;const c=de(e.serviceMbsInIndexSR,a,"none",n,t);ee(v,c);let l=null;const h=()=>{if(!l)if(l=De,_(x),e.serviceObbInIndexSR!=null){e.serviceObbInIndexSR.transform(j,n,t,a,i),j.getCorners(l);for(const s of l)I(s,s,v),D(x,s)}else{const s=e.serviceMbsInIndexSR;if(!s)return;const f=s[3];L(se(s),n,d,t),I(d,d,v),d[2]+=a;for(let m=0;m<8;++m){const T=1&m?f:-f,R=2&m?f:-f,$=4&m?f:-f,E=l[m];ie(E,[d[0]+T,d[1]+R,d[2]+$]),D(x,E)}}};let y=1/0,u=-1/0;const p=s=>{if(s.type!=="replace")return;const f=s.geometry;if(!(f!=null&&f.hasZ))return;_(N);const m=f.spatialReference||r,T=f.rings.reduce((R,$)=>$.reduce((E,C)=>(re(d,C[0],C[1],C[2]),L(d,m,d,t),I(d,d,v),D(N,d),Math.min(d[2],E)),R),1/0);h(),ae(x,N)&&(y=Math.min(y,T),u=Math.max(u,T))};if(o.forEach(s=>p(s)),y===1/0)return null;const g=(s,f,m)=>{I(d,m,c),s[f]=d[0],s[f+1]=d[1],s[f+2]=d[2],f+=24,m[2]=y,I(d,m,c),s[f]=d[0],s[f+1]=d[1],s[f+2]=d[2],f+=24,m[2]=u,I(d,m,c),s[f]=d[0],s[f+1]=d[1],s[f+2]=d[2]};for(let s=0;s<8;++s)g(G.data,3*s,l[s]);return le(G)}function Ze(e){return e[3]>=0}function Ve(e){e!=null&&(e[3]=-1)}const De=[S(),S(),S(),S(),S(),S(),S(),S()],N=O(),x=O(),j=new oe,d=S(),G={data:new Array(72),size:3,exclusive:!0,stride:3},v=K();export{Me as $,pe as A,we as B,Le as D,Ee as H,ye as K,je as L,We as N,Ae as O,Ge as Q,Ue as U,Ie as V,Ke as X,Pe as Y,w as _,Je as c,Ze as f,ze as i,_e as k,He as l,de as n,Ve as p,qe as r,Be as s,Fe as t,Qe as u,k as z};
