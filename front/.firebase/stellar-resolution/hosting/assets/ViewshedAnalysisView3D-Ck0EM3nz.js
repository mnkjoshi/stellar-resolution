import{cY as y,J as ie,ks as Lt,ap as ne,hx as q,qz as Q,bh as S,ee as ti,ef as It,ec as Ut,dT as ue,au as p,eh as B,fn as we,DB as ii,DC as si,DL as Se,ej as fe,eR as P,eH as Qe,av as X,aw as j,mX as Oe,u as C,eP as kt,v7 as ce,DM as De,t4 as jt,qB as Te,at as K,v8 as Ie,ax as ai,Z as M,a as x,kT as Ue,es as ri,th as ke,bd as G,qy as je,vd as tt,n7 as Ve,DN as W,v5 as oi,wQ as me,eS as ni,DO as li,kt as hi,r as l,m as u,c as be,a3 as de,L as ci,dj as Be,CP as di,x8 as ui,eZ as it,di as pi,jc as vi,b2 as wi,y$ as fi,b as se,k3 as Xe,dl as ge,$ as Bt,q3 as st,al as We,wc as mi,eT as gi,G as _i,xS as Vi,az as bi,aM as Mi,aK as yi,wb as Si,bf as Wt,ex as Ke,F as Di,dS as Oi,bb as Ti,tw as $i,tz as xi,kr as at,b8 as Ri,DP as rt,DQ as Ai,DR as Ci,DS as Pi,DT as ot,DU as nt,d2 as Fi,BG as Ei,DV as Hi,DW as zi,DX as Li,pt as Nt,mw as qt,BP as Ne,kS as lt,BH as Ii,DY as Ui,DZ as ki,D_ as ji,D$ as Bi,Cp as ht,Da as xe,Cr as Re,BR as Wi,BS as ct,E0 as dt,E1 as Ni,E2 as qi,BT as Gi,BU as Qi,_ as Xi,BW as Ki,Ds as Yi,B$ as Ji,E3 as Zi,V as es,E4 as Ae,E5 as ut,pU as ts,nH as is,wT as ss,kQ as as,ky as pt,e7 as rs,e8 as os,er as ns,hV as ls,rl as hs,E6 as cs,dh as ds,bv as us,D as ps,hY as vs}from"./index-BCRx-hwS.js";import{d as ws,m as fs}from"./featureReferenceUtils-B16s7UxU.js";import{o as ms,s as gs,m as _s,f as Vs,d as vt}from"./analysisViewUtils-B--emzOE.js";import{O as bs,w as Ms,a as oe,e as $e,f as ys,c as Ss,d as ae,t as Ds}from"./ShadedColorMaterial.glsl-CI7N3McU.js";import{c as Os}from"./Viewshed-D24zUyBi.js";import{T as wt,A as Ts}from"./dragEventPipeline3D-DHg4AehP.js";import{B as Gt,A as ee,o as Qt,a as $s,u as xs,j as Rs}from"./MoveManipulation-tg4ablmc.js";import{p as ye,M as As,h as Ce,f as Cs}from"./InteractiveToolBase-Cty8kcDX.js";import{s as Ye}from"./sliceToolConfig--wE4rP0r.js";import{A as Xt}from"./ColorMaterial.glsl---Y6rLLC.js";import{E as Ps}from"./EditGeometryOperations-DzaQFUYT.js";import{G as Fs}from"./ExtendedLineVisualElement-Bz5I4uPt.js";import{c as Es}from"./LaserlinePath.glsl-BAMGwSy6.js";import{o as Hs}from"./ToolIntersector-B8n2Y4Qc.js";import{S as zs}from"./PointVisualElement-DbRh4LKx.js";import{h as Ls}from"./lineStippleUtils-C89mzWlO.js";import"./VisualElement-C7VHkPsy.js";import"./line-CjGKkHIf.js";import"./TriangleMaterial-Bf5qGOHH.js";import"./EngineVisualElement-CI6xbbHp.js";const ft=2,Is=4,Kt=y(2),Us=1.5;let ks=class{constructor(){this.collisionRadius=5,this.fovUnfocusedArcWidth=Is,this.fovFocusedArcWidth=ft*this.fovUnfocusedArcWidth,this.scaleOrientSize=90,this.scaleOrientHandleRadius=.025,this.scaleOrientMinDistance=1,this.scaleOrientArrowTipLength=.3,this.scaleOrientArrowTipFocusMultiplier=ft/1.5,this.observerSize=5,this.hoverTimeoutMilliseconds=1e3,this.viewAngleThreshold=10}getFovArcWidth(t){return t?this.fovFocusedArcWidth:this.fovUnfocusedArcWidth}getScaleOrientArrowTipLength(t){return this.scaleOrientArrowTipLength*(t?this.scaleOrientArrowTipFocusMultiplier:1)}};const H=new ks;class js{constructor(){this.frameWidthNotSelected=.3,this.frameWidthSelected=1,this.frameColor=new ie([255,255,255,.99]),this.observerPointConfiguration={size:6,pixelSnappingEnabled:!1,primitive:"circle",elevationInfo:{mode:"absolute-height",offset:0},outlineSize:0,color:ie.toUnitRGBA(new ie([3,252,111,1]))},this.shapeMaterialParameters={color:[.33,.33,.33,.25],renderOccluded:ne.Occlude,cullFace:Lt.Back,writeDepth:!1}}}const J=new js;function Je({tiltedUpVector:i,rightVector:t,observerRenderSpace:e},s){const a=bs(i,t,e,s);return a[12]=0,a[13]=0,a[14]=0,a}function qe(i,t,e,s){const a=p(),r=ti(e.plane),o=Bs(t,r);let n;if(Math.abs(o)>H.viewAngleThreshold)n=i.next(wt(t,e.plane));else{const d=It(s.targetRenderSpace,e.basis1,Ut()),c=ue(Yt,e.basis1),h=ue(Ws,e.basis2);n=i.next(wt(t,d)).next(v=>{const w=T=>{const D=fe(P(mt,T,e.origin),h),R=Math.acos(Qe(D/s.farDistanceRenderSpace,-1,1)),F=Math.sin(R)*s.farDistanceRenderSpace;return X(p(),e.origin,X(p(),j(mt,c,F),j(Ns,h,D)))},f=w(v.renderStart),m=w(v.renderEnd);return{...v,renderStart:f,renderEnd:m}})}return n.next(d=>{d.action==="start"&&B(a,d.renderStart);const c=we(Ms(a,d.renderEnd,e.origin,r));return{...d,deltaAngle:c}})}function Bs(i,t){const e=Yt;i.renderCoordsHelper.toRenderCoords(i.camera.position,e);const s=ii(i,e,i.camera.heading,i.camera.tilt,si()).direction;return we(Se(s,t))-90}function te(i,t,e,s){return Q(gt,e,s),q(i,t,gt)}const Yt=p(),Ws=p(),mt=p(),Ns=p(),gt=S();let qs=class extends Gt{constructor(t){super(),this._handles=new Oe,this._tool=t.tool,this._view=t.view,this._focusedArcMaterial=this._createArcMaterial(!0),this._unfocusedArcMaterial=this._createArcMaterial(!1),this._createManipulators(),this.forEachManipulator(e=>this._tool.manipulators.add(e))}destroy(){this._handles=C(this._handles),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._tool=null,this._view=null,this._manipulators=null}createDragPipeline(t,e){const s=Object.values(this._manipulators);return kt(s.map(({manipulator:a,side:r})=>ye(a,(o,n,d,c,h)=>{const v=Js(r,e),w=n.next(m=>({...m,manipulatorType:ee.SCALE,side:r})),f=qe(w,this._view,v,e);t(o,f,d)})))}updateManipulatorsTransform(t){t.arcCentersPoints(_t),this._forEachManipulatorInfo(e=>this._updateArcManipulatorTransform(e,t,_t[e.side]))}updateManipulatorVisuals(t){this._forEachManipulatorInfo(e=>this._updateArcManipulatorVisuals(e,t))}_updateArcManipulatorVisuals({manipulator:t,side:e},s){const a=[];if(s!=null){const[r,o]=Gs(e,s,this._unfocusedArcMaterial);a.push(new oe(r,ce.Unfocused),new oe(r.instantiate({material:this._focusedArcMaterial}),ce.Focused)),t.collisionType={type:"line",paths:[o]}}t.renderObjects=a,t.radius=H.collisionRadius}_updateArcManipulatorTransform({manipulator:t,side:e},s,a){const r=s.horizontalFieldOfView,o=y(s.verticalFieldOfView/2),n=y(r/2),d=_e(e);t.renderLocation=a;const c=S(),h=T=>{Ue(c,T,c)};h(De(le,y(-90))),d||h(jt(le,o));const v=s.farDistanceRenderSpace;let w,f;h(Te(le,K(Jt,v,v,v))),h(Ie(le,Ks(e))),h(Je(s,le)),d?(w=n,f=s.tiltedUpVector):(f=s.rightVector,w=o),w*=e==="right"||e==="bottom"?-1:1;const m=Q(le,w,f);m!=null&&h(m),t.modelTransform=c}_createManipulators(){const t=this._createArcManipulator("left"),e=this._createArcManipulator("right"),s=this._createArcManipulator("top"),a=this._createArcManipulator("bottom");this._manipulators={left:t,right:e,top:s,bottom:a},[[a.manipulator,s.manipulator],[t.manipulator,e.manipulator]].forEach(([r,o])=>{r.metadata={pairedManipulator:o},o.metadata={pairedManipulator:r}})}_createArcManipulator(t){const e=new $e({view:this._view,autoScaleRenderObjects:!1,worldSized:!0}),s={manipulator:e,side:t};return this._updateArcManipulatorVisuals(s),this._handles.add(e.events.on("focus-changed",a=>{var o;const r=(o=e.metadata)==null?void 0:o.pairedManipulator;r!=null&&(r.hovering!==e.hovering&&(r.hovering=e.hovering),r.grabbing!==e.grabbing&&(r.grabbing=e.grabbing))})),s}_createArcMaterial(t){const e=H.getFovArcWidth(t),s=new ai({renderOccluded:ne.OccludeAndTransparent,isDecoration:!0,width:e});return this._handles.add(M(()=>ie.toUnitRGBA(this._view.effectiveTheme.accentColor),a=>s.setParameters({color:a}),x)),s}forEachManipulator(t){Object.values(this._manipulators).forEach(({manipulator:e})=>t(e,ee.SCALE))}_forEachManipulatorInfo(t){Object.values(this._manipulators).forEach(e=>t(e))}get test(){return{manipulators:this._manipulators}}};function Gs(i,t,e){const{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=_e(i),o=y(Qe((r?a:s)/2,0,15)),n=Qs(-o/2,o/2,r?1:Math.max(Math.sin(y(90-a/2)),.1));return[ri(e,n),n]}function Qs(i,t,e,s=10){ke(s>1,"createArcPolylineGeometry() needs at least 2 for numVertices");const a=t-i;if(a<=0||e<=0)return[G(0,0,.01),G(0,0,-.01)];const r=[],o=a/s;for(let n=0;n<s;n++){let d=i+n*o;n===s-1&&(d=t);const c=Math.cos(d)*e,h=Math.sin(d)*e,v=G(c-e,0,h);r.push(v)}return r}function Xs(i){switch(i){case"left":return 0;case"bottom":return 1;case"right":return 2;case"top":return 3}}function Ks(i){return Xs(i)*Zs}function _e(i){return i==="left"||i==="right"}function Ys(i){return i==="left"?"right":i==="right"?"left":i==="top"?"bottom":"top"}function Js(i,{observerRenderSpace:t,targetRenderSpace:e,tiltedUpVector:s,rightVector:a,farDistanceRenderSpace:r}){const o=P(Jt,e,t),n=_e(i)?a:s,d=j(ea,n,r);return je(t,o,d)}const Zs=Math.PI/2,le=S(),Jt=p(),ea=p(),_t={top:p(),bottom:p(),left:p(),right:p()};let Pe=class extends $e{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.collisionRadius}),this._handles=new Oe,this._setupManipulatorVisual(e)}destroy(){this._handles.remove(),super.destroy()}_setupManipulatorVisual(t){const e=this._createMaterial(),s=1,a=[G(0,0,0),G(0,0,s)],r=tt(e,a,t,16,!1),o=tt(e,a,t*Ye,16,!1),n=Vt(!1,e,t),d=Vt(!0,e,t),c=S();Ve(c,a[a.length-1]),W(c,c,jt(bt,Math.PI/2)),W(c,c,De(bt,Math.PI/2)),n.transformation=c,d.transformation=c,this.renderObjects=[new oe(r,ce.Unfocused),new oe(o,ce.Focused),new oe(n,ce.Unfocused),new oe(d,ce.Focused)];const h=G(0,H.getScaleOrientArrowTipLength(!0),0),v=q(h,h,c),w=[...a,v];this.collisionType={type:"line",paths:[w]}}_createMaterial(){const t=new Xt({cullFace:Lt.Back,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});return this._handles.add(M(()=>ie.toUnitRGBA(this.view.effectiveTheme.accentColor),e=>t.setParameters({color:e}),x)),t}};function Vt(i,t,e){const s=H.getScaleOrientArrowTipLength(i);let a=2*e;i&&(a*=Ye);const r=s/2;return oi(t,s,r,r,a,0)}const bt=S();let ta=class extends Gt{constructor(t){super(),this._handles=new Oe,this._tool=t.tool,this._view=t.view;const e=H.scaleOrientHandleRadius;this._manipulatorHeading=new Pe(this._view,e),this._manipulatorTilt=new Pe(this._view,e),this._manipulatorDistance=new Pe(this._view,e),this.forEachManipulator(s=>this._tool.manipulators.add(s))}destroy(){this._handles.destroy(),this.forEachManipulator(t=>{this._tool.manipulators.remove(t),t.destroy()}),this._manipulatorHeading=null,this._manipulatorTilt=null,this._manipulatorDistance=null,this._tool=null,this._view=null}createHeadingDragPipeline(t,e){return ye(this._manipulatorHeading,(s,a,r,o,n)=>{const d=this._view,{tiltParallelToSurface:c,farDistanceRenderSpace:h,upVector:v,observerRenderSpace:w,targetRenderSpace:f,rightVector:m}=e,T=Math.sin(y(c))*h,D=X(Me,w,j(Fe,v,T)),R=P(Fe,f,D),F=j(ia,m,me(R)),A=je(D,R,F),z=qe(a,d,A,e).next(L=>({...L,manipulatorType:ee.ROTATE}));t(s,z,r)})}createTiltDragPipeline(t,e){return ye(this._manipulatorTilt,(s,a,r,o,n)=>{const{observerRenderSpace:d,farDistanceRenderSpace:c,upVector:h,targetDirection:v}=e,w=fe(v,h),f=ni(Me,v,h,-w);j(f,ue(f,f),c);const m=j(Fe,h,c),T=je(d,f,m),D=qe(a,this._view,T,e).next(R=>({...R,manipulatorType:ee.ROTATE}));t(s,D,r)})}createDistanceDragPipeline(t,e){return ye(this._manipulatorDistance,(s,a,r,o,n)=>{const d=li(e.observerRenderSpace,e.targetDirection),c=a.next(As(this._view,s.location)).next(Ts(this._view,d)).next(h=>({...h,manipulatorType:ee.SCALE}));t(s,c,r)})}updateManipulators(t){const{targetRenderSpace:e}=t;this._manipulatorHeading.renderLocation=e,this._manipulatorTilt.renderLocation=e,this._manipulatorDistance.renderLocation=e;const s=S(),a=h=>{Ue(s,h,s)},r=H.scaleOrientSize*(Qt/$s);a(Te(pe,K(Me,r,r,r))),a(Je(t,pe));const o=H.scaleOrientHandleRadius*Ye*r,n=j(Me,t.targetDirection,o);a(Ve(pe,n));const d=Ie(pe,-Ee);W(d,d,De(Mt,-Ee)),this._manipulatorHeading.modelTransform=W(S(),s,d);const c=De(pe,Ee);W(c,c,Ie(Mt,Math.PI)),this._manipulatorTilt.modelTransform=Ue(S(),s,c),this._manipulatorDistance.modelTransform=s}forEachManipulator(t){t(this._manipulatorHeading,ee.ROTATE),t(this._manipulatorTilt,ee.ROTATE),t(this._manipulatorDistance,ee.SCALE)}};const pe=S(),Mt=S(),Me=p(),Fe=p(),ia=p(),Ee=Math.PI/2;let Zt=class extends $e{constructor(t,e){super({view:t,autoScaleRenderObjects:!1,worldSized:!1,radius:H.observerSize,interactive:!1}),this._handles=new Oe;const s=ys(this._color);this.renderObjects=[new oe(hi(s,H.observerSize,32,32))],e.manipulators.add(this),this._handles.add([M(()=>this._color,a=>{s.setParameters({color:a})},x)])}destroy(){this._handles.remove(),super.destroy()}get _color(){return ie.toUnitRGBA(this.view.effectiveTheme.accentColor)}};l([u()],Zt.prototype,"_color",null);const yt=Symbol("dragHandles"),St=Symbol("hideManipulators"),Dt=Symbol("hideFoVManipulators"),Ot=Symbol("hideObserverManipulator");let I=class extends be{constructor(t){super(t),this._moveManipulation=null,this._observerManipulator=null,this._fieldOfViewManipulation=null,this._scaleOrientManipulation=null,this._forceHoveringTask=null,this._forceHoveringTestPromise=null,this._grabbing=!1,this.viewshedComputedData=null}initialize(){this._moveManipulation=this._createMoveManipulation(),this._fieldOfViewManipulation=new qs({view:this.view,tool:this.parentTool}),this._scaleOrientManipulation=new ta({view:this.view,tool:this.parentTool}),this._observerManipulator=new Zt(this.view,this.parentTool),this.addHandles([M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.observerRenderSpace},e=>{e!=null&&(this._moveManipulation.renderLocation=e,this._observerManipulator.renderLocation=e)},de),M(()=>{var e;return(e=this.viewshedComputedData)==null?void 0:e.heading},e=>{e&&(this._moveManipulation.angle=y(90-e))},x),M(()=>{const{viewshedComputedData:e}=this;return{viewshedComputedData:e,observer:e==null?void 0:e.observer}},({viewshedComputedData:e,observer:s},a)=>{this._grabbing&&s!==(a==null?void 0:a.observer)||(this.removeHandles(yt),e!=null&&e.valid&&this.addHandles([this._buildObserverDragPipeline(e),this._buildFOVDragPipeline(e),this._buildScaleOrientDragPipeline(e)].filter(ci),yt))},x),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.valid?{viewshedCompData:e,target:e.targetRenderSpace,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorsTransform(e.viewshedCompData)},x),M(()=>{const e=this.viewshedComputedData;return e!=null&&e.valid?{viewshedCompData:e,hFOV:e.horizontalFieldOfView,vFOV:e.verticalFieldOfView,tilt:e.tilt}:null},e=>{e!=null&&this._fieldOfViewManipulation.updateManipulatorVisuals(e.viewshedCompData)},x),M(()=>{var a;const e=this.analysisViewData.visible&&(((a=this.viewshedComputedData)==null?void 0:a.valid)??!1),s=this.parentTool.selectedViewshedComputedData===this.viewshedComputedData;return{fovManipulationAvailable:e&&!this.parentTool.isPlacingTarget,nonFOVManipulationAvailable:e&&(!this.parentTool.creating||s)}},({fovManipulationAvailable:e,nonFOVManipulationAvailable:s})=>{this._moveManipulation.available=s,this._scaleOrientManipulation.available=s,this._observerManipulator.available=s,this._fieldOfViewManipulation.available=e},x),M(()=>{const e=this.viewshedComputedData;if(!(e!=null&&e.valid))return null;const{observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}=e;return{viewshedCompData:e,observer:s,target:a,verticalFieldOfView:r,horizontalFieldOfView:o}},e=>{e!=null&&this._scaleOrientManipulation.updateManipulators(e.viewshedCompData)},x)]);const t=e=>{const s=this.analysisViewData;this.addHandles([e.events.on("focus-changed",()=>{const a=this._someManipulatorHovering();a&&this.parentTool.subToolHandles.forEach(({subTool:r})=>{r._resetHoveringTask()}),this._someManipulatorSelected()||a||(this._forceHoveringTask=pi(async r=>{await(this._forceHoveringTestPromise??vi(H.hoverTimeoutMilliseconds,r)),wi(r),this._forceHoveringTask=null,this._updateManipulatorVisibility()}))}),e.events.on("grab-changed",a=>{var r;this._grabbing=a.action==="start",a.action==="end"&&((r=s.tool)==null||r.updateInteractionVisualsVisibility()),this.parentTool.subToolHandles.forEach(({subTool:o})=>{o!==this&&o._setInteractive(!this._grabbing)}),this._setInteractive(o=>o.hasManipulator(e)||!this._grabbing)}),e.events.on("drag",a=>{var r;a.action==="start"&&((r=s.tool)==null||r.updateInteractionVisualsVisibility())})])};this._forEachManipulator(t)}destroy(){this._forceHoveringTask=Be(this._forceHoveringTask),this._moveManipulation=C(this._moveManipulation),this._fieldOfViewManipulation=C(this._fieldOfViewManipulation),this._scaleOrientManipulation=C(this._scaleOrientManipulation),this.parentTool.manipulators.remove(this._observerManipulator),this._observerManipulator=C(this._observerManipulator)}get viewshed(){var t;return(t=this.viewshedComputedData)==null?void 0:t.viewshed}get grabbing(){return this._grabbing}get observer(){var t;return(t=this.viewshed)==null?void 0:t.observer}set observer(t){const e=this.viewshed;e!=null&&(e.observer=t)}get discManipulator(){return this._moveManipulation.xyManipulation.discManipulator}get moveInteractionState(){const{dragging:t,grabbing:e}=this._moveManipulation;return{dragging:t,grabbing:e}}get scaleOrientInteractionState(){const{dragging:t,grabbing:e}=this._scaleOrientManipulation;return{dragging:t,grabbing:e}}_setInteractive(t){const e=typeof t=="boolean";this._forEachManipulation(s=>s.interactive=e?t:t(s))}onManipulatorSelectionChanged(){this._updateManipulatorVisibility(),!this._someManipulatorSelected()&&(this.analysisViewData.selectedViewshed===this.viewshed&&(this.analysisViewData.selectedViewshed=null),this._resetHoveringTask())}hasManipulator(t){let e=!1;return this._forEachManipulator(s=>{e=e||s===t}),e}_someManipulatorSelected(){return this._moveManipulation.selected||this._fieldOfViewManipulation.selected||this._scaleOrientManipulation.selected}_someManipulatorHovering(){return this._moveManipulation.hovering||this._fieldOfViewManipulation.hovering||this._scaleOrientManipulation.hovering}_createMoveManipulation(){return new xs({view:this.view,tool:this.parentTool,snapToScene:!1,xyAvailable:!0,xyAxisAvailable:!0,zAvailable:!0,radius:Qt})}_buildObserverDragPipeline(t){const e={mode:"absolute-height",offset:0},s=t.observer;if(s==null)return null;const a=this.view.spatialReference;return this._moveManipulation.createDragPipeline((r,o,n,d,c)=>{d=d.next(Ce(this,["observer"]));const h=di(s,a);if(h==null)return{steps:n,cancel:d};const v=Ps.fromGeometry(h,ui(this.view.viewingMode));return{steps:n.next(Cs({operations:v})).next(w=>(this.observer=v.data.geometry,w)),cancel:d}},e,a,void 0)}_buildFOVDragPipeline(t){let e=0,s=0;return this._fieldOfViewManipulation.createDragPipeline((a,r,o)=>{if(t==null)return{steps:r,cancel:o};const n=t.viewshed;let d=null;return o=o.next(Ce(n,["horizontalFieldOfView","verticalFieldOfView"])),{steps:r.next(c=>{c.action==="start"&&(d=null,e=t.horizontalFieldOfView,s=t.verticalFieldOfView);const h=c.deltaAngle;if(d==null&&h!==0){const f=c.side==="bottom"||c.side==="left"?h>0:h<0;d=_e(c.side)?e===0&&f||e===360&&!f:s===0&&f}const v=d?Ys(c.side):c.side;let w=0;switch(v){case"left":w=e/2-h;break;case"right":w=e/2+h;break;case"top":w=s+2*h;break;case"bottom":w=s-2*h}return _e(v)?(w=it.normalize(w),w=w>270?0:w>180?180:w,n.horizontalFieldOfView=2*w):n.verticalFieldOfView=w,c}),cancel:o}},t)}_buildScaleOrientDragPipeline(t){let e=0,s=0;const a=(r,o)=>(n,d,c)=>{if(t==null)return{steps:d,cancel:c};const h=t.viewshed;return c=c.next(Ce(h,[r])),{steps:d=d.next(o(h,t)),cancel:c}};return kt([this._scaleOrientManipulation.createHeadingDragPipeline(a("heading",(r,o)=>n=>(n.action==="start"&&(s=t.heading),r.heading=it.normalize(s+n.deltaAngle),n)),t),this._scaleOrientManipulation.createTiltDragPipeline(a("tilt",(r,o)=>n=>{n.action==="start"&&(e=t.tilt);let d=e+n.deltaAngle;return d<-90?d=180:d>270&&(d=0),r.tilt=aa.clamp(d),n}),t),this._scaleOrientManipulation.createDistanceDragPipeline(a("farDistance",(r,o)=>n=>{const d=P(sa,n.renderEnd,o.observerRenderSpace),c=me(d)*o.metersPerUnit,h=fe(d,o.targetDirection)<0?H.scaleOrientMinDistance:c;return r.farDistance=h,n}),t)])}_updateManipulatorVisibility(){const t=this._someManipulatorSelected(),e=this._forceHoveringTask!=null||this._someManipulatorHovering(),s=this._fieldOfViewManipulation.hovering,a=this.parentTool.creating;let r=[];const o=n=>{r.push(n.disableDisplay())};t||!a&&e?this.removeHandles(St):(this._scaleOrientManipulation.forEachManipulator(o),this._moveManipulation.forEachManipulator(o),this.addHandles(r,St),r=[]),t||!a&&e||a&&s?this.removeHandles(Dt):(this._fieldOfViewManipulation.forEachManipulator(o),this.addHandles(r,Dt)),t||!a?this.removeHandles(Ot):this.addHandles(this._observerManipulator.disableDisplay(),Ot)}_resetHoveringTask(){this._forceHoveringTask=Be(this._forceHoveringTask),this._updateManipulatorVisibility()}_forEachManipulator(t){this._forEachManipulation(e=>{e.forEachManipulator(t)}),t(this._observerManipulator)}_forEachManipulation(t){t(this._moveManipulation),t(this._fieldOfViewManipulation),t(this._scaleOrientManipulation)}get test(){return{moveManipulation:this._moveManipulation,fieldOfViewManipulation:this._fieldOfViewManipulation,scaleOrientManipulation:this._scaleOrientManipulation,viewshedComputedData:this.viewshedComputedData,setHoveringTimeoutPromise:t=>{this._forceHoveringTestPromise=t}}}};l([u({constructOnly:!0})],I.prototype,"analysis",void 0),l([u({constructOnly:!0})],I.prototype,"analysisViewData",void 0),l([u({constructOnly:!0})],I.prototype,"parentTool",void 0),l([u({constructOnly:!0,nonNullable:!0})],I.prototype,"view",void 0),l([u()],I.prototype,"viewshed",null),l([u()],I.prototype,"_grabbing",void 0),l([u()],I.prototype,"grabbing",null),l([u()],I.prototype,"viewshedComputedData",void 0),l([u()],I.prototype,"observer",null),I=l([se("esri.views.3d.analysis.Viewshed.ViewshedSubTool")],I);const sa=p(),aa=new fi(0,180),He=Symbol("interactionVisuals");let O=class extends ms{constructor(i){super(i),this.removeIncompleteOnCancel=!1,this.automaticManipulatorSelection=!1,this._stagedViewshed=null,this._stagedViewshedComputedData=null,this._placementMode=xt,this._creationState=!1,this._interactionVisualElements=null,this._settings=new Rs({getTheme:()=>this.view.effectiveTheme}),this._selectedManipulator=null}initialize(){this._intersector=Hs(this.view.state.viewingMode),this._createInteractionVisuals();const i=this.analysisViewData.viewshedComputedDataHandles;this.subToolHandles=Xe(()=>i,({viewshedComputedData:t})=>{const e=new I({analysis:this.analysis,analysisViewData:this.analysisViewData,parentTool:this,view:this.view,viewshedComputedData:t});return{subTool:e,remove:()=>{this.selectedViewshed===t.viewshed&&(this.selectedViewshed=null),e.destroy()}}}),this.addHandles([ge(()=>this._valid,()=>this.finishToolCreation(),de),M(()=>this._stagedViewshed,t=>{var s;const e=this.analysisViewData.viewshedComputedDataHandles;this._stagedViewshedComputedData=t!=null&&e!=null?(s=this._findSubTool(t))==null?void 0:s.viewshedComputedData:null},de),this.analysis.viewsheds.on("after-remove",t=>{const e=this._stagedViewshed;e!=null&&t.item===e&&this.analysis.viewsheds.add(e)}),M(()=>this.firstGrabbedManipulator,t=>{var e,s;if(t!=null){const a=(e=this._findSubTool(t))==null?void 0:e.viewshed;this.selectedViewshed=a,this._selectManipulator(t)}else(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged()},Bt),M(()=>this.view.activeTool,t=>{t!==this&&t!=null&&(this.selectedViewshed=null)}),ge(()=>{const t=this.selectedViewshedComputedData;return t==null?null:{subTool:this._selectedSubTool,observer:t.observerRenderSpace,target:t.targetRenderSpace}},t=>{const{subTool:e,observer:s,target:a}=t;e!=null&&e.moveInteractionState.dragging?this._updateInteractionVisualsLocation(s,!0):e!=null&&e.scaleOrientInteractionState.dragging&&this._updateInteractionVisualsLocation(a,!1)},x),M(()=>this.creating,()=>this.updateInteractionVisualsVisibility()),M(()=>this.selectedViewshed,t=>{const e=this._selectedManipulator,s=this._selectedSubTool;t==null?this._selectManipulator(null):e!=null&&s.hasManipulator(e)||this._selectManipulator(s.discManipulator)},x)])}destroy(){this.subToolHandles=C(this.subToolHandles),this.removeHandles(He)}onDeactivate(){this.removeStaged(),this._creationState=!1}get _valid(){var i;return((i=this.analysisViewData.viewshedComputedDataHandles)==null?void 0:i.some(t=>t.viewshedComputedData.valid))??!1}get cursor(){return this.creating?"crosshair":null}get _selectedSubTool(){return this._findSubTool(this.selectedViewshed)}_selectManipulator(i){var e,s;const t=this._selectedManipulator;t!==i&&(this._selectedManipulator=i,t!=null&&(t.selected=!1),i!=null&&(i.selected=!0),(e=this._findSubTool(t))==null||e.onManipulatorSelectionChanged(),(s=this._selectedSubTool)==null||s.onManipulatorSelectionChanged())}get selectedViewshed(){return this.analysisViewData.selectedViewshed}set selectedViewshed(i){this.analysisViewData.selectedViewshed=i}get selectedViewshedComputedData(){var i;return(i=this._selectedSubTool)==null?void 0:i.viewshedComputedData}get stagedViewshed(){return this._stagedViewshed}get grabbing(){return this.subToolHandles.some(({subTool:i})=>i.grabbing)}get creating(){return this._creationState&&this.active}get isPlacingTarget(){return this._creationState==="placing-target"}place(i){this.selectedViewshed=null,this._placementMode=i,this._creationState="placing-observer",this._finishToolCreationIfValid()}onManipulatorSelectionChanged(){this.subToolHandles.forEach(i=>i.subTool.onManipulatorSelectionChanged())}onInputEvent(i){switch(i.type){case"immediate-double-click":this._doubleClickHandler(i);break;case"pointer-move":this._pointerMoveHandler(i);break;case"key-down":st.cancel===i.key?this._cancelKeyHandler(i):st.delete.includes(i.key)&&this._deleteKeyHandler();break;case"hold":this.updateInteractionVisualsVisibility(!0)}}onInputEventAfter(i){i.type==="immediate-click"&&this._clickPlacementHandler(i)}onActivate(){this._placementMode=xt}_clickPlacementHandler(i){if(!this.creating||this.hasFocusedManipulators)return;const t=this._intersectScreen(i,$t);if(t!=null){if(this._creationState==="placing-observer"){t.mapPoint.z=(t.mapPoint.z??0)+Us;const e=new Os({observer:t.mapPoint.clone(),feature:t.feature});this.analysis.viewsheds.add(e),this._stagedViewshed=e,this._creationState="placing-target",this._updateStagedViewshed(t.scenePoint)}else if(this._creationState==="placing-target"){this._updateStagedViewshed(t.scenePoint);const e=this._stagedViewshed;this._stagedViewshed=null,this._placementMode==="multiple"?this._creationState="placing-observer":(this._creationState=!1,this._stagedViewshed=null,this._finishToolCreationIfValid(),this.view.activeTool=null),this.selectedViewshed=e}i.stopPropagation()}}_doubleClickHandler(i){this.creating&&(this.removeStaged(),this._creationState=!1,this.view.activeTool=null,i.stopPropagation())}_pointerMoveHandler(i){if(!this.creating)return;const t=this._intersectScreen(i,$t);t!=null&&(this._updateInteractionVisualsLocation(t.scenePoint,!1),this._updateStagedViewshed(t.scenePoint))}_cancelKeyHandler(i){this.creating?this._onCancelWhileCreating(i):this.grabbing||(this.selectedViewshed=null,i.stopPropagation())}_onCancelWhileCreating(i){const t=this.removeStaged();this._finishToolCreationIfValid(),t?(this._creationState="placing-observer",this.selectedViewshed=null,this._placementMode==="multiple"&&i.stopPropagation()):this._creationState=!1}_deleteKeyHandler(){this.creating&&(this.removeStaged(),this._creationState="placing-observer"),this.selectedViewshed!=null&&this.analysis.viewsheds.remove(this.selectedViewshed)}_finishToolCreationIfValid(){this._valid&&this.finishToolCreation()}_updateStagedViewshed(i){const t=this._stagedViewshed,e=this._stagedViewshedComputedData;if(t==null||e==null)return;const{heading:s,tilt:a,farDistance:r}=ra(this.view,e,i);t.farDistance=r,t.tilt=a,t.heading=s}removeStaged(){const i=this._stagedViewshed;return i!=null&&(this._stagedViewshed=null,this.analysis.viewsheds.remove(i),!0)}_intersectScreen(i,t){const e=mi(i);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const s=this._intersector.results.min,a=t.scenePoint;if(!s.getIntersectionPoint(a))return null;const r=t.mapPoint;return r.spatialReference=this.view.spatialReference,this.view.renderCoordsHelper.fromRenderCoords(a,r),r==null?null:(t.feature=gi(s,this.view),t)}_createInteractionVisuals(){this.removeHandles(He);const i=this._settings.visualElements,t=new Es({view:this.view,attached:!1,style:{glowWidth:i.heightPlane.glowWidth,innerWidth:i.heightPlane.innerWidth},isDecoration:!0}),e=new Fs({view:this.view,extensionType:i.zVerticalLine.extensionType,attached:!1,innerWidth:1,writeDepthEnabled:!1,renderOccluded:ne.OccludeAndTransparent,isDecoration:!0});this._interactionVisualElements={laserline:t,verticalLine:e},this.addHandles([M(()=>i.zVerticalLine,s=>s.apply(e),de),M(()=>i.heightPlane,s=>s.apply(t),de),_i(()=>{t.destroy(),e.destroy(),this._interactionVisualElements=null})],He)}updateInteractionVisualsVisibility(i=!1){const t=this.creating,e=this.analysisViewData.visible,s=this._selectedSubTool,a=this.selectedViewshedComputedData,r=(v,w)=>{const f=this._interactionVisualElements;f!=null&&(f.verticalLine.attached=w,f.laserline.attached=v)};if(t)return void r(e,!1);if(s==null||a==null)return void r(!1,!1);const o=s.moveInteractionState,n=i?o.grabbing:o.dragging,d=s.scaleOrientInteractionState,c=i?d.grabbing:d.dragging,h=e&&(n||c);if(r(h,n),h){const v=n?a.observerRenderSpace:a.targetRenderSpace;this._updateInteractionVisualsLocation(v,n)}}_updateInteractionVisualsLocation(i,t){const e=this._interactionVisualElements;if(e==null)return;const{laserline:s,verticalLine:a}=e;s.heightManifoldTarget=i,s.intersectsWorldUpAtLocation=t?i:null,i!=null&&a.setStartEndFromWorldDownAtLocation(i)}_findSubTool(i){var e,s;if(i==null)return null;const t=i instanceof $e?a=>a.subTool.hasManipulator(i):a=>a.subTool.viewshed===i;return(s=(e=this.subToolHandles)==null?void 0:e.find(t))==null?void 0:s.subTool}get test(){}};function ra(i,t,e){const s=t.observerRenderSpace,a=P(oa,e,s),r=me(a)*t.metersPerUnit,o=i.renderCoordsHelper.basisMatrixAtPosition(s,ha),n=K(na,o[8],o[9],o[10]),d=It(s,n,ca),c=Vi(d,e,la),h=P(c,c,s),v=(me(h)<1e-4?90:we(Se(a,h)))*(fe(n,a)<0?-1:1)+90,w=K(Tt,o[4],o[5],o[6]),f=we(Se(w,h)),m=K(Tt,o[0],o[1],o[2]);return{heading:fe(h,m)<0?360-f:f,tilt:v,farDistance:r}}l([u({constructOnly:!0})],O.prototype,"view",void 0),l([u()],O.prototype,"analysisViewData",void 0),l([u()],O.prototype,"removeIncompleteOnCancel",void 0),l([u()],O.prototype,"automaticManipulatorSelection",void 0),l([u({constructOnly:!0})],O.prototype,"analysis",void 0),l([u()],O.prototype,"subToolHandles",void 0),l([u()],O.prototype,"_stagedViewshed",void 0),l([u()],O.prototype,"_stagedViewshedComputedData",void 0),l([u()],O.prototype,"_placementMode",void 0),l([u()],O.prototype,"_creationState",void 0),l([u()],O.prototype,"_valid",null),l([u({readOnly:!0})],O.prototype,"cursor",null),l([u()],O.prototype,"_selectedManipulator",void 0),l([u()],O.prototype,"_selectedSubTool",null),l([u()],O.prototype,"selectedViewshed",null),l([u()],O.prototype,"selectedViewshedComputedData",null),l([u()],O.prototype,"stagedViewshed",null),l([u()],O.prototype,"grabbing",null),l([u()],O.prototype,"creating",null),l([u()],O.prototype,"isPlacingTarget",null),O=l([se("esri.views.3d.analysis.Viewshed.ViewshedTool")],O);const oa=p(),na=p(),la=p(),Tt=p(),ha=S(),ca=Ut(),$t={mapPoint:new We,scenePoint:p(),feature:null},xt="multiple";class da extends Ss{constructor(t){super(t),this._material=null,this._viewshedComputedData=null,this._material=new Xt({...J.shapeMaterialParameters,isDecoration:this.isDecoration,writeDepth:!1}),this.applyProperties(t)}get viewshedComputedData(){return this._viewshedComputedData}set viewshedComputedData(t){this._viewshedComputedData=t,this.updateTransform()}updateTransform(){const t=this._viewshedComputedData;if(t==null)return;const e=S(),s=t.farDistanceRenderSpace;Te(e,G(s,s,s)),Je(t,ve),W(e,ve,e),Ve(ve,this._viewshedComputedData.observerRenderSpace),W(e,ve,e),this.transform=e}createExternalResources(){}destroyExternalResources(){}forEachMaterial(t){t(this._material)}createGeometries(t){const{_material:e,viewshedComputedData:s}=this;s==null||e==null||!s.valid||ua(e,s).forEach(a=>t.addGeometry(a))}}function ua(i,t){const{horizontalFieldOfView:e,verticalFieldOfView:s}=t,a=K(pa,0,0,1),r=K(At,0,1,0),o=K(Ct,1,0,0);te(a,a,y(s/2),r),te(a,a,y(e/2),o);const n=b=>Math.ceil(Math.abs(b)/Kt)+1,d=y(e),c=B(va,o),h=n(d),v=Rt(-d/(h-1)),w=Q(ve,v,c),f=y(-s),m=n(f),T=Rt(f/(m-1)),D=B(At,r),R=Q(Pt,y(e)/2,o);q(D,D,R);const F=Pt,A=[],z=B(Ct,a);for(let b=0;b<h;b++){Q(F,T,D);for(let _=0;_<m;_++){const V=3*(_*h+b);A[V]=z[0],A[V+1]=z[1],A[V+2]=z[2],q(z,z,F)}q(D,D,w),q(a,a,w),B(z,a)}const L=h*m;A[3*L]=0,A[3*L+1]=0,A[3*L+2]=0;const N=[];for(let b=0;b<h-1;b++)for(let _=0;_<m-1;_++){const V=6*(_*(h-1)+b);N[V]=_*h+b,N[V+1]=(_+1)*h+b,N[V+2]=_*h+b+1,N[V+3]=_*h+b+1,N[V+4]=(_+1)*h+b,N[V+5]=(_+1)*h+b+1}const Y=[N];if(e!==360&&s!==0){const b=[],_=[];for(let V=0;V<m-1;V++){const $=3*V;b[$]=L,b[$+1]=(V+1)*h,b[$+2]=V*h,_[$]=L,_[$+1]=V*h+h-1,_[$+2]=(V+1)*h+h-1}Y.push(b,_)}if(s!==180&&e!==0){const b=[],_=[];for(let V=0;V<h-1;V++){const $=3*V;b[$]=L,b[$+1]=V,b[$+2]=V+1,_[$]=L,_[$+1]=V+(m-1)*h+1,_[$+2]=V+(m-1)*h}Y.push(b,_)}return Y.map(b=>{const _=[[bi.POSITION,new Mi(A,b,3,!0)]];return new yi(i,_)})}function Rt(i){return isNaN(i)?1:i}const pa=p(),At=p(),Ct=p(),va=p(),ve=S(),Pt=S();let U=class extends be{constructor(t){super(t),this.visible=!0,this._viewshedCorners={topLeft:p(),topRight:p(),bottomLeft:p(),bottomRight:p()},this._arcCenterPoints={top:p(),bottom:p(),left:p(),right:p()},this._parallelCenters={top:p(),bottom:p()}}initialize(){const t={view:this.view,isDecoration:!0},e={...t,color:this._color,renderOccluded:ne.OccludeAndTransparent},s={...e,stipplePattern:Ls(2)};this._observerVisualElement=new zs({...t,...J.observerPointConfiguration}),this._shapeVisualElement=new da({...t,isDecoration:this.isDecoration}),this._frameLinesVisualElement=new ae(e),this._leftArcVisualElement=new ae(e),this._rightArcVisualElement=new ae(e),this._topArcVisualElement=new ae(e),this._bottomArcVisualElement=new ae(e),this._centralLongitude=new ae(s),this._centralLatitude=new ae(s),this.addHandles([M(()=>{const a=this.viewshedComputedData;if(!(a!=null&&a.valid))return null;const r=this._viewshedCorners,o=this._arcCenterPoints,n=this._parallelCenters;return a.cornerPoints(r),a.arcCentersPoints(o),a.parallelCenterPoints(n),{viewshedComputedData:a,corners:r,arcCenters:o,parallelCenters:n,interactive:this.analysisViewData.interactive,selected:this._selected}},a=>{const r=a!=null;this._forEachVisualElement(o=>o.attached=r),r&&this._updateVisualElements(a)},{initial:!0,equals:Si}),M(()=>{const{viewshedComputedData:a}=this,{horizontalFieldOfView:r,verticalFieldOfView:o}=a??{};return{viewshedComputedData:a,horizontalFieldOfView:r,verticalFieldOfView:o}},({viewshedComputedData:a})=>{const{_shapeVisualElement:r}=this;a!==r.viewshedComputedData&&(r.viewshedComputedData=a),this._shapeVisualElement.recreateGeometry()},x),M(()=>{var r;const{interactive:a}=this.analysisViewData;return{visible:this.visible,selected:a&&this._selected,staged:a&&this._staged,horFovNot360:((r=this.viewshedComputedData)==null?void 0:r.horizontalFieldOfView)!==360}},({visible:a,selected:r,staged:o,horFovNot360:n})=>{const d=r||o;this._shapeVisualElement.visible=a,this._topArcVisualElement.visible=a,this._bottomArcVisualElement.visible=a,this._frameLinesVisualElement.visible=a&&n;const c=a&&(r||n);this._leftArcVisualElement.visible=c,this._rightArcVisualElement.visible=c,this._forEachLineVisualElement(h=>{h.width=d?J.frameWidthSelected:J.frameWidthNotSelected,h.renderOccluded=r?ne.OccludeAndTransparent:ne.Occlude}),[this._centralLatitude,this._centralLongitude].forEach(h=>{h.width=2*(d?J.frameWidthSelected:J.frameWidthNotSelected),h.visible=a&&r})},x),M(()=>{const{analysisViewData:{interactive:a,tool:r},_selected:o,visible:n}=this,d=this.view.activeTool,c=!(r!=null&&r.active)&&d instanceof O&&d.creating;return{observerVisible:n&&!o&&(!a||((r==null?void 0:r.creating)??!1)||c),color:this._color}},({observerVisible:a,color:r})=>{this._observerVisualElement.visible=a,this._forEachLineVisualElement(o=>o.color=r)},x)])}get _color(){var n,d;const{viewshedComputedData:t,_selected:e,analysisViewData:s}=this;if(t==null)return ie.toUnitRGBA(J.frameColor);const a=((n=s.tool)==null?void 0:n.active)||s.interactive,r=t.viewshed===((d=s.tool)==null?void 0:d.stagedViewshed),o=a&&(e||r)?this.view.effectiveTheme.accentColor:J.frameColor;return ie.toUnitRGBA(o)}get _selected(){const{viewshedComputedData:t,analysisViewData:{selectedViewshedComputedData:e}}=this;return t!=null&&t===e}get _staged(){const{analysisViewData:{tool:t},viewshedComputedData:e}=this;return t!=null&&t.creating&&t.stagedViewshed===(e==null?void 0:e.viewshed)}destroy(){this._observerVisualElement=C(this._observerVisualElement),this._shapeVisualElement=C(this._shapeVisualElement),this._frameLinesVisualElement=C(this._frameLinesVisualElement),this._leftArcVisualElement=C(this._leftArcVisualElement),this._rightArcVisualElement=C(this._rightArcVisualElement),this._topArcVisualElement=C(this._topArcVisualElement),this._bottomArcVisualElement=C(this._bottomArcVisualElement),this._centralLongitude=C(this._centralLongitude),this._centralLatitude=C(this._centralLatitude)}_forEachLineVisualElement(t){[this._frameLinesVisualElement,this._leftArcVisualElement,this._rightArcVisualElement,this._topArcVisualElement,this._bottomArcVisualElement,this._centralLatitude,this._centralLongitude].forEach(t)}_forEachVisualElement(t){this._forEachLineVisualElement(t),t(this._observerVisualElement),t(this._shapeVisualElement)}_updateVisualElements(t){const{viewshedComputedData:e,corners:s,arcCenters:a,parallelCenters:r}=t,o=Wt(e.observerRenderSpace);this._observerVisualElement.geometry=e.observer,this._shapeVisualElement.updateTransform(),this._updateFrameLines(o,s),this._updateFrameArcs(e,s,r),this._updateCentralHelperArcs(e,a)}_updateFrameLines(t,e){this._frameLinesVisualElement.geometry=[[t,e.topLeft],[t,e.topRight],[t,e.bottomLeft],[t,e.bottomRight]]}_updateFrameArcs(t,e,s){const{observerRenderSpace:a,rightVector:r,horizontalFieldOfView:o,tiltedUpVector:n}=t,d=y(o),c=p(),h=S();Q(h,d/2,n),q(c,r,h),he(this._leftArcVisualElement,a,e.bottomLeft,e.topLeft,"forward",c),Q(h,-d/2,n),K(c,0,0,0),q(c,r,h),he(this._rightArcVisualElement,a,e.bottomRight,e.topRight,"forward",c);const v=o>180?"backward":"forward";he(this._topArcVisualElement,s.top,e.topRight,e.topLeft,v,n),he(this._bottomArcVisualElement,s.bottom,e.bottomRight,e.bottomLeft,v,n)}_updateCentralHelperArcs(t,e){const s=t.observerRenderSpace,a=t.horizontalFieldOfView>=180?"backward":"forward";he(this._centralLatitude,s,e.right,e.left,a,t.tiltedUpVector),he(this._centralLongitude,s,e.top,e.bottom,"forward",t.leftVector)}get test(){}};function he(i,t,e,s,a,r,o=Kt){const n=p();P(n,e,t);const d=me(n),c=p();P(c,s,t),ue(c,c),j(c,c,d);let h=Se(n,c);const v=Wt(r);a==="backward"&&(Ke(v,v),h=-(2*Math.PI-h));const w=[],f=Math.ceil(Math.abs(h)/o),m=S();Q(m,h/f,v);const T=p();B(T,n);const D=p();B(D,e);for(let R=0;R<f;R++){const F=p();B(F,D),q(T,T,m),X(D,t,T);const A=p();B(A,D),w.push([F,A])}i.geometry=w}l([u()],U.prototype,"view",void 0),l([u({constructOnly:!0})],U.prototype,"isDecoration",void 0),l([u()],U.prototype,"analysisViewData",void 0),l([u()],U.prototype,"viewshedComputedData",void 0),l([u()],U.prototype,"visible",void 0),l([u()],U.prototype,"_color",null),l([u()],U.prototype,"_selected",null),l([u()],U.prototype,"_staged",null),U=l([se("esri.views.3d.analysis.Viewshed.ViewshedVisualization")],U);let re=class extends be{get visible(){return this.analysisViewData.visible}constructor(i){super(i)}initialize(){const i=this.analysisViewData,t=Xe(()=>this.analysisViewData.viewshedComputedDataHandles,({viewshedComputedData:e})=>{const s=new U({view:this.view,viewshedComputedData:e,analysisViewData:i,isDecoration:this.isDecoration});return{visualization:s,remove:()=>s.destroy()}});this._viewshedVisualizations=t,this.addHandles([Di(t),M(()=>this.visible,e=>this._viewshedVisualizations.forEach(({visualization:s})=>s.visible=e),x)])}get test(){}};l([u({constructOnly:!0})],re.prototype,"analysisViewData",void 0),l([u({constructOnly:!0,nonNullable:!0})],re.prototype,"view",void 0),l([u({constructOnly:!0})],re.prototype,"isDecoration",void 0),l([u()],re.prototype,"visible",null),re=l([se("esri.views.3d.analysis.Viewshed.ViewshedAnalysisVisualization")],re);var Ge;let g=Ge=class extends be{constructor(i){super(i),this.observerRenderSpaceOverride=null,this.needUpdateByFeature=!1}get observer(){return this.viewshed.observer??new We}get effectiveObserverRenderSpace(){return this.observerRenderSpaceOverride??this.observerRenderSpace}get effectiveObserver(){return this.renderSpaceToPoint(this.effectiveObserverRenderSpace,this.observer.spatialReference)}get effectiveTargetRenderSpace(){return this._computeTargetRenderSpace(this.effectiveObserverRenderSpace)}get farDistance(){return this.viewshed.farDistance}get farDistanceRenderSpace(){return this.farDistance/this.metersPerUnit}get heading(){return this.viewshed.heading}get tilt(){return this.viewshed.tilt}get feature(){return this.viewshed.feature}get tiltParallelToSurface(){return this.tilt-90}get horizontalFieldOfView(){return this.viewshed.horizontalFieldOfView}get verticalFieldOfView(){return this.viewshed.verticalFieldOfView}get observerRenderSpace(){return this._pointToRenderSpace(this.observer,p())}get target(){const i=this.targetRenderSpace;return this.renderSpaceToPoint(i,this.observer.spatialReference)}get targetRenderSpace(){return this._computeTargetRenderSpace(this.observerRenderSpace)}get targetDirection(){const i=P(p(),this.targetRenderSpace,this.observerRenderSpace);return ue(i,i)}get tiltedUpVector(){const i=te(p(),this.upVector,-y(this.tiltParallelToSurface),this.leftVector);return ue(i,i)}get _basis(){return this.renderCoordsHelper.basisMatrixAtPosition(this.observerRenderSpace,S())}get upVector(){const i=this._basis;return G(i[8],i[9],i[10])}get northVector(){const i=this._basis;return G(i[4],i[5],i[6])}get leftVector(){const i=this.upVector,t=te(p(),this.northVector,-y(this.heading),i);return Oi(t,i,t)}get rightVector(){return Ke(p(),this.leftVector)}clone(){return new Ge({renderCoordsHelper:this.renderCoordsHelper,viewshed:this.viewshed.clone()})}get valid(){return this.viewshed.valid}get metersPerUnit(){return this.renderCoordsHelper.spatialReference.metersPerUnit}pointOnSphere(i,t,e){const{observerRenderSpace:s,targetRenderSpace:a}=this,r=P(ze,a,s);return te(r,r,-y(t),this.leftVector),te(r,r,-y(i),this.tiltedUpVector),X(e,r,s)}cornerPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(-t,e,i.topLeft),this.pointOnSphere(t,e,i.topRight),this.pointOnSphere(-t,-e,i.bottomLeft),this.pointOnSphere(t,-e,i.bottomRight)}arcCentersPoints(i){const t=this.horizontalFieldOfView/2,e=this.verticalFieldOfView/2;this.pointOnSphere(0,e,i.top),this.pointOnSphere(0,-e,i.bottom),this.pointOnSphere(-t,0,i.left),this.pointOnSphere(t,0,i.right)}parallelCenterPoints(i){const t=this.observerRenderSpace,e=this.farDistanceRenderSpace*Math.sin(y(this.verticalFieldOfView/2)),s=j(ze,this.tiltedUpVector,e);X(i.top,t,s),P(i.bottom,t,s)}renderSpaceToPoint(i,t){const e=ze;return this.renderCoordsHelper.fromRenderCoords(i,e,t),new We(e[0],e[1],e[2],t)}_pointToRenderSpace(i,t){const e=Ti(i.toArray());return this.renderCoordsHelper.toRenderCoords(e,i.spatialReference,t),t}_computeTargetRenderSpace(i){const{leftVector:t,northVector:e,upVector:s}=this,a=this.farDistanceRenderSpace,r=p();return j(r,e,a),te(r,r,-y(this.heading),s),te(r,r,-y(this.tiltParallelToSurface),t),X(r,i,r),r}};l([u()],g.prototype,"renderCoordsHelper",void 0),l([u()],g.prototype,"viewshed",void 0),l([u()],g.prototype,"observerRenderSpaceOverride",void 0),l([u()],g.prototype,"needUpdateByFeature",void 0),l([u()],g.prototype,"observer",null),l([u()],g.prototype,"effectiveObserverRenderSpace",null),l([u()],g.prototype,"effectiveObserver",null),l([u()],g.prototype,"effectiveTargetRenderSpace",null),l([u()],g.prototype,"farDistance",null),l([u()],g.prototype,"farDistanceRenderSpace",null),l([u()],g.prototype,"heading",null),l([u()],g.prototype,"tilt",null),l([u()],g.prototype,"feature",null),l([u()],g.prototype,"tiltParallelToSurface",null),l([u()],g.prototype,"horizontalFieldOfView",null),l([u()],g.prototype,"verticalFieldOfView",null),l([u()],g.prototype,"observerRenderSpace",null),l([u()],g.prototype,"target",null),l([u()],g.prototype,"targetRenderSpace",null),l([u()],g.prototype,"targetDirection",null),l([u()],g.prototype,"tiltedUpVector",null),l([u()],g.prototype,"_basis",null),l([u()],g.prototype,"upVector",null),l([u()],g.prototype,"northVector",null),l([u()],g.prototype,"leftVector",null),l([u()],g.prototype,"rightVector",null),l([u()],g.prototype,"valid",null),l([u()],g.prototype,"metersPerUnit",null),g=Ge=l([se("esri.views.3d.analysis.Viewshed.ViewshedComputedData")],g);const ze=p();let Z=class extends $i{constructor(){super(...arguments),this.sectionAngles=xi()}get sectionAnglesDeg(){return at(this.sectionAngles.map(t=>we(t)))}set sectionAnglesDeg(t){this.sectionAngles=at(t.map(e=>y(e)))}get projectionMatrix(){return W(S(),this.sectionMatrix,this._projectionMatrixInternal)}get sectionMatrix(){const t=this.sectionAngles[0],e=this.sectionAngles[1],s=this.sectionAngles[2],a=this.sectionAngles[3];ke(t<=e),ke(s<=a);const r=2*Math.tan(this.fovX/2),o=2*Math.tan(this.fovY/2),n=Math.tan(t),d=Math.tan(e),c=Math.tan(s),h=d-n,v=Math.tan(a)-c,w=r/h,f=o/v,m=-(n+h/2)/r*2,T=-(c+v/2)/o*2,D=S();Ve(D,[m,T,0]);const R=S();Te(R,[w,f,1]);const F=S();return W(F,R,D)}get _sectionRatioX(){const t=Math.tan(this.sectionAngles[0]),e=Math.tan(this.sectionAngles[1]),s=2*Math.tan(this.fovX/2);return Math.min(1,(e-t)/s)}setViewport(t,e){const s=e*this._sectionRatioX;return this.viewport=[t[0],t[1],s,e],s}};l([u()],Z.prototype,"sectionAngles",void 0),l([u()],Z.prototype,"sectionAnglesDeg",null),l([u()],Z.prototype,"projectionMatrix",null),l([u()],Z.prototype,"sectionMatrix",null),l([u()],Z.prototype,"_sectionRatioX",null),Z=l([se("esri.views.3d.webgl-engine.lib.ViewshedFaceCamera")],Z);class wa{constructor(){this.textureSizeQuality=1,this.textureSizeModHighQuality=1.3,this.textureSizeModLowQuality=.9,this.textureSizeMultiple=128,this.toleranceSides=5,this.toleranceBottomTop=10}textureSizeModifier(t){const e=t?this.textureSizeModHighQuality:this.textureSizeModLowQuality;return this.textureSizeQuality*e}textureResizeModulo(t){return Math.ceil(t/this.textureSizeMultiple)*this.textureSizeMultiple}}const Ft=["front","left","right","back","top","bottom"];function fa(i){return!["top","bottom"].includes(i)}class ma{constructor(t){this._fbos=t,this._faces={},this._width=0,this._height=0,this.settings=new wa,this._maxTextureSize=Math.min(Ri("esri-mobile")?4096:16384,t.rctx.parameters.maxTextureSize)}get depthTexture(){var t;return(t=this._handle)==null?void 0:t.getTexture(rt)}get ready(){return this.depthTexture!=null&&this._width!==0&&this._height!==0}get nearFar(){const t=this.faces;return t.length===0?null:t[0].nearFar}get numActiveFaces(){const t=this._faces;let e=0;return Object.keys(t).forEach(s=>{t[s]&&(e+=1)}),e}get faces(){const t=this._faces,e=[];for(const s of Ft){const a=t[s];a&&e.push(a)}return e}get atlasRegions(){return this.faces.map(t=>[t.x/this._width,(t.x+t.width)/this._width,t.y/this._height,(t.y+t.height)/this._height])}get viewshedProjectionMatrices(){return this.faces.map(t=>t.projectionMatrix)}get viewshedViewMatrices(){return this.faces.map(t=>t.viewMatrix)}_setupFaceCamera(t,e,s,a){const{effectiveObserverRenderSpace:r,tiltedUpVector:o,targetRenderSpace:n,farDistanceRenderSpace:d,horizontalFieldOfView:c,verticalFieldOfView:h}=e,v=p();P(v,n,r);const w=p(),f=p(),m=(_,V)=>{const $=p(),et=S();return Q(et,_,V),q($,v,et),X($,r,$),$};let T,D=o;const R=Math.min(90,c),F=Math.min(90,Math.max(0,(c-90)/2));let A=-45,z=45,L=-45,N=45;if(fa(t)){const _=V=>Qe(V,-45,45);L=_(-h/2)-this.settings.toleranceBottomTop,N=_(+h/2)+this.settings.toleranceBottomTop}switch(t){case"front":T=n,A=-R/2,z=R/2;break;case"left":T=m(Math.PI/2,o),A=45-F;break;case"right":T=m(-Math.PI/2,o),z=-45+F;break;case"top":T=X(w,r,o),D=Ke(f,v);break;case"bottom":T=P(w,r,o),D=v;break;case"back":T=m(Math.PI,o)}const Y=new Z({center:T,eye:r,up:D,far:d});Y.sectionAnglesDeg=[A-this.settings.toleranceSides,z+this.settings.toleranceSides,L,N],Y.fovY=Math.PI/2;const b=Y.setViewport(s,a);return this._faces[t]=Y,b}isActive(t){return this._computeActiveFaces(t).size>0}_computeActiveFaces(t){const e=new Set,{horizontalFieldOfView:s,verticalFieldOfView:a}=t,r=-a/2,o=a/2;return s===0||a===0||(r<=45&&o>=-45&&e.add("front"),s>90&&(e.add("left"),e.add("right")),s>270&&e.add("back"),o>45-this.settings.toleranceBottomTop&&e.add("top"),r<-45+this.settings.toleranceBottomTop&&e.add("bottom")),e}_computeBaseTextureSize({pixelRatio:t,fullWidth:e,fullHeight:s},a,r,o){const n=a/t,d=this.settings.textureSizeModifier(r);return Ai(Math.max(e,s)*n*d,this._maxTextureSize/o)}_ensureFBO(t){var r,o,n,d;const e=this._width,s=this._height,a=(r=this._handle)==null?void 0:r.fbo;a&&a.width===e&&a.height===s&&t===Ci(((n=(o=a.depthStencilTexture)==null?void 0:o.descriptor)==null?void 0:n.internalFormat)??Pi.DEPTH_COMPONENT16)||((d=this._handle)==null||d.release(),this._handle=this._allocateFBO(t))}_allocateFBO(t){var o;const{_width:e,_height:s}=this,a=t?ot.DEPTH24_STENCIL8:ot.DEPTH16,r=this._fbos.acquire(e,s,"viewshed shadow map",a);return(o=r.getTexture(rt))==null||o.setShadowFiltering(!1),r}clearFBO(t){var s;const e=this._fbos.rctx;this._ensureFBO(t),e.bindFramebuffer((s=this._handle)==null?void 0:s.fbo),e.setClearColor(1,1,1,1),e.clear(nt.COLOR|nt.DEPTH)}dispose(){this._debugFBO||(this._handle=Fi(this._handle))}start(t,e,s,a,r=!1){this._faces={};const o=this._computeActiveFaces(e),n=o.size;if(n===0)return!1;const d=this._computeBaseTextureSize(t,a,s,n);let c=0,h=0,v=0;return Ft.filter(w=>o.has(w)).forEach(w=>{const f=ga(w,n);f>h&&(v=Math.max(v,c),c=0),h=f;const m=f*d;c+=this._setupFaceCamera(w,e,[c,m],d)}),v=Math.max(v,c),this._width=this.settings.textureResizeModulo(v),this._height=_a(n)*d,this.clearFBO(r),!0}finish(){}get test(){}}function ga(i,t){if(t<4)return 0;const e=i==="front"||i==="left";return t===4?e?0:1:e||i==="right"?0:1}function _a(i){return i<4?1:2}class Va extends Ei{constructor(){super(...arguments),this.localOrigin=Hi()}}function ba(i){i.include(zi),i.fragment.uniforms.add(new Li("inverseViewMatrix",(t,e)=>{const s=Nt(S(),e.camera.viewMatrix,t.localOrigin);return qt(s,s)})).code.add(Ne`vec4 reconstructLocalPosition(vec2 coord, float linearDepth) {
vec4 cameraSpace = vec4(reconstructPosition(coord, linearDepth), 1.0);
return inverseViewMatrix * cameraSpace;
}`)}let Ze=class extends Va{constructor(){super(...arguments),this.shadowMap={depthTexture:null,nearFar:[1,100],numActiveFaces:1,atlasRegions:[[0,0,1,1]]},this.targetVector=[1,0,0],this.upVector=[0,0,1],this.fovs=[45,45],this.headingAndTilt=[0,0],this.observerOffset=[0,0,0],this.projectionMatrices=lt.flat(),this.viewMatrices=lt.flat(),this.volumeOffset=0}};function ei(){const i=new Ii,t=i.fragment;return i.include(Ui),i.include(ba),t.include(ki),t.include(ji),t.uniforms.add(new Bi("depthTexture",e=>{var s;return(s=e.depth)==null?void 0:s.attachment}),new ht("inverseProjectionMatrix",e=>e.camera.inverseProjectionMatrix),new ht("inverseViewNormalMatrix",({camera:e})=>qt(Ma,e.viewInverseTransposeMatrix)),new xe("viewshedObserverOffset",e=>e.observerOffset),new xe("viewshedTargetVector",e=>e.targetVector),new xe("viewshedUpVector",e=>e.upVector),new Re("viewshedFOVs",e=>e.fovs),new Re("viewshedHeadingAndTilt",e=>e.headingAndTilt),new Re("viewshedNearFar",e=>e.shadowMap.nearFar??[1,100]),new Wi("viewshedVolumeOffset",e=>e.volumeOffset),new ct("viewshedShadowMap",e=>e.shadowMap.depthTexture),new dt("viewshedProjectionMatrices",e=>e.projectionMatrices,6),new dt("viewshedViewMatrices",e=>e.viewMatrices,6),new Ni("viewshedNumFaces",e=>e.shadowMap.numActiveFaces),new qi("viewshedAtlasRegions",e=>e.shadowMap.atlasRegions.flat(),24),new ct("normalMap",e=>e.normals)),t.constants.add("visibleColor","vec4",[0,1,0,.5]),t.constants.add("occludedColor","vec4",[1,0,0,.5]),t.code.add(Ne`vec2 getViewshedUv(vec4 worldPosition, int face) {
mat4 viewshedMatrix = viewshedProjectionMatrices[face];
vec4 viewshedUv4 = viewshedMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
return viewshedUv.xy;
}
float viewshedDepthToFloat(float depth) {
return (depth - viewshedNearFar[0]) / (viewshedNearFar[1] - viewshedNearFar[0]);
}
float getOrthographicDepthToViewshed(vec4 worldPosition, int face) {
mat4 viewshedViewMatrix = viewshedViewMatrices[face];
vec4 viewshedUv4 = viewshedViewMatrix * worldPosition;
vec3 viewshedUv = viewshedUv4.xyz / viewshedUv4.w;
float depth = -viewshedUv.z;
return viewshedDepthToFloat(depth);
}
float viewshedReadShadowMapDepth(sampler2D _viewshedShadowmap, ivec2 uv) {
return texelFetch(_viewshedShadowmap, uv, 0).r;
}
float viewshedFilterShadow(sampler2D _viewshedShadowmap, vec2 uv) {
vec2 uvScaled = uv * vec2(textureSize(_viewshedShadowmap, 0));
vec2 st    = fract(uvScaled);
ivec2 base = ivec2(uvScaled);
float s00 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y    ));
float s10 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y    ));
float s11 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x + 1, base.y + 1));
float s01 = viewshedReadShadowMapDepth( _viewshedShadowmap, ivec2(base.x,     base.y + 1));
return mix(mix(s00, s10, st.x), mix(s01, s11, st.x), st.y);
}
float viewshedTextureAtlasLookup(sampler2D _viewshedShadowmap, vec2 uv, vec4 atlasRegion) {
vec2 atlasScale = atlasRegion.zw - atlasRegion.xy;
vec2 uvAtlas = fract(uv) * atlasScale + atlasRegion.xy;
return viewshedFilterShadow(_viewshedShadowmap, uvAtlas);
}
float getDepthFromShadowMap(vec2 uv, int face) {
int index = 4 * face;
float umin = viewshedAtlasRegions[index];
float umax = viewshedAtlasRegions[index + 1];
float vmin = viewshedAtlasRegions[index + 2];
float vmax = viewshedAtlasRegions[index + 3];
vec4 atlasRegion = vec4(umin, vmin, umax, vmax);
return viewshedTextureAtlasLookup(viewshedShadowMap, uv, atlasRegion);
}
struct ViewshedPoint {
int face;
vec2 uv;
bool isWithin;
float orthographicDepth;
};
mat3 rotationMatrix(vec3 axis, float angle)
{
float s = sin(angle);
float c = cos(angle);
float oc = 1.0 - c;
return mat3(
oc * axis.xxz * axis.xyx + vec3(c, axis.zy) * vec3(1., -s, s),
oc * axis.xyy * axis.yyz + vec3(axis.z, c, axis.x) * vec3(s, 1., -s),
oc * axis.zyz * axis.xzz + vec3(axis.yx, c) * vec3(-s, s, 1.)
);
}
float distanceToPlane(vec3 position, vec3 normal) {
return dot(position, normal);
}
bool outsideViewshed(float distance) {
return distance > -viewshedVolumeOffset;
}
bool isWithinViewshed(vec3 position) {
float positionLength = length(position - viewshedObserverOffset);
float farSphereDistance = positionLength - viewshedNearFar[1];
if (outsideViewshed(farSphereDistance)) { return false; }
float nearSphereDistance = viewshedNearFar[0] - positionLength;
if (outsideViewshed(nearSphereDistance)) { return false; }
vec3 westVector = normalize(cross(viewshedUpVector, viewshedTargetVector));
bool leftOfTarget = distanceToPlane(position, westVector) > 0.0;
if (viewshedFOVs[0] < TWO_PI) {
float horAngle = viewshedFOVs[0] / 2.0;
horAngle = leftOfTarget ? horAngle : -horAngle;
vec3 sideVector = viewshedTargetVector * rotationMatrix(viewshedUpVector, horAngle);
bool inFront = distanceToPlane(position, sideVector) > 0.0;
if (inFront) {
vec3 sideNormal = cross(viewshedUpVector, sideVector) * (leftOfTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
} else if (viewshedFOVs[0] < PI) { return false; }
}
if (viewshedFOVs[1] < PI) {
float t = dot(viewshedUpVector, position);
vec3 nProjVector = normalize(position - t * viewshedUpVector);
float heading = acos(clamp(dot(normalize(viewshedTargetVector), nProjVector), -1.0, 1.0));
heading = leftOfTarget ? heading : -heading;
bool aboveTarget = distanceToPlane(position, viewshedUpVector) > 0.0;
float verFOV = viewshedFOVs[1] / 2.0;
verFOV = aboveTarget ? -verFOV : verFOV;
mat3 rotateByHeading = rotationMatrix(viewshedUpVector, heading);
vec3 sideVector = viewshedTargetVector * rotationMatrix(westVector, verFOV) * rotateByHeading;
vec3 leftVector = westVector * rotateByHeading;
vec3 sideNormal = cross(sideVector, leftVector) * (aboveTarget ? 1. : -1.);
float sideDistance = distanceToPlane(position, normalize(sideNormal));
if (outsideViewshed(sideDistance)) { return false; }
}
return true;
}
bool getViewshedPoint(vec4 localPosition, out ViewshedPoint point) {
for(int i=0; i < viewshedNumFaces; i++) {
vec2 viewshedUv = getViewshedUv(localPosition, i);
if (viewshedUv.x > 0. && viewshedUv.x < 1. && viewshedUv.y > 0. && viewshedUv.y < 1.) {
float orthoDepth = getOrthographicDepthToViewshed(localPosition, i);
if (orthoDepth >= 0.) {
bool isWithin = isWithinViewshed(localPosition.xyz);
point = ViewshedPoint(i, viewshedUv, isWithin, orthoDepth);
return true;
}
}
}
return false;
}
float normalCosAngle(float linearDepth, vec3 localPosition) {
vec4 normal4 = texture(normalMap, uv);
vec3 normalN = normalize(normal4.xyz * 2.0 - 1.0);
vec3 normal =  normalize((inverseViewNormalMatrix * vec4(normalN, 1.0)).xyz);
vec3 viewingDir = normalize(localPosition);
return dot(normal, viewingDir);
}`),t.main.add(Ne`float depth = depthFromTexture(depthTexture, uv);
if (depth >= 1.0 || depth <= 0.0) {
return;
}
float linearDepth = linearizeDepth(depth);
vec4 localPosition = reconstructLocalPosition(gl_FragCoord.xy, linearDepth);
ViewshedPoint point;
bool foundFace = getViewshedPoint(localPosition, point);
if (!foundFace || !point.isWithin) {
return;
}
float viewshedDepth = getDepthFromShadowMap(point.uv, point.face);
float distance = point.orthographicDepth;
bool visible = distance < viewshedDepth;
fragColor = visible ? visibleColor : occludedColor;
float cosAngle = normalCosAngle(linearDepth, localPosition.xyz);
float threshold = -0.01;
if (cosAngle > threshold) {
fragColor = occludedColor;
}`),i}const Ma=S(),ya=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ze,build:ei},Symbol.toStringTag,{value:"Module"}));class Et extends Gi{constructor(t,e){super(t,e,new Qi(ya,()=>Xi(()=>Promise.resolve().then(()=>xa),void 0)))}initializePipeline(){return Ki({colorWrite:Ji,blending:Yi})}}let k=class extends Zi{get shadowMap(){return this._shadowMap}get hasViewsheds(){return this._viewsheds.length>0}get _contentPixelRatio(){return this.view.state.contentPixelRatio}get _viewshedsInView(){return this._viewsheds.items.filter(i=>Oa(this.view,i))}constructor(i){super(i),this.isDecoration=!1,this._passParameters=new Ze,this._viewsheds=new es,this._shadowMap=null,this.consumes={required:[Ae.VIEWSHED,"normals"]},this.produces=Ae.VIEWSHED,this.requireGeometryDepth=!0}initialize(){this._shadowMap=new ma(this.fboCache),this.addHandles([M(()=>this.view.resolutionScale,i=>{const t=this._shadowMap;t&&(t.settings.textureSizeQuality=i)},x),ge(()=>!this.hasViewsheds,()=>{var i;return(i=this._shadowMap)==null?void 0:i.dispose()}),M(()=>this._viewshedsInView.map(i=>[i.observerRenderSpace,i.heading,i.tilt,i.farDistance,i.horizontalFieldOfView,i.verticalFieldOfView]),()=>this.requestRender(ut.UPDATE),Bt)])}destroy(){this._shadowMap=ts(this._shadowMap)}precompile(){var i;if(this.hasViewsheds){this.techniques.precompile(Et);for(const t of this._viewshedsInView)if((i=this._shadowMap)!=null&&i.isActive(t))return void this.view.stage.renderer.precompileViewshedShadowMap()}}render(i){var o,n,d;const t=this.bindParameters,e=this.renderingContext,s=i.find(({name:c})=>c===Ae.VIEWSHED);if(!this.hasViewsheds||!t.depth||this.isDecoration&&!t.decorations)return s;this._passParameters.shadowMap=this._shadowMap??this._passParameters.shadowMap,this._passParameters.normals=(o=i.find(({name:c})=>c==="normals"))==null?void 0:o.getTexture();const a=this.techniques.get(Et);if(!(a!=null&&a.compiled))return this.requestRender(ut.UPDATE),s;const r=this.view.stage.renderer.isFeatureEnabled(is.HighResolutionViewshed);for(const c of this._viewshedsInView){if(!this._renderShadowCubeMap(t,c,r)||!((n=this._shadowMap)!=null&&n.ready))continue;const h=this._setupViewshedParameters(c,t.camera);e.bindTechnique(a,t,h),e.bindFramebuffer(s.fbo),e.screen.draw()}return(d=this.shadowMap)==null||d.dispose(),s}updateViewsheds(i){const t=this._viewsheds,{removes:e,adds:s}=i;if(e&&(Array.isArray(e)?t.removeMany(e):t.remove(e)),s)if(Array.isArray(s)){const a=s.filter(r=>!t.includes(r));t.addMany(a)}else t.includes(s)||t.add(s)}_renderShadowCubeMap(i,t,e){const s=this._shadowMap;if(!s)return!1;const a=this.view.basemapTerrain.hasStencilEnabledExtents,r=s.start(i.camera,t,e,this._contentPixelRatio,a);return r&&s.faces.forEach(o=>this.view.stage.renderer.renderViewshedShadowMap(o)),s.finish(),r}_setupViewshedParameters(i,t){var d;const e=this._shadowMap;if(!e)return this._passParameters;const s=this._passParameters,a=i.effectiveObserverRenderSpace;s.localOrigin=a,s.observerOffset=P($a,i.observerRenderSpace,i.effectiveObserverRenderSpace),s.fovs=[y(i.horizontalFieldOfView),y(i.verticalFieldOfView)],s.headingAndTilt=[y(i.heading),y(i.tiltParallelToSurface)],s.upVector=i.tiltedUpVector;const r=Sa(i.targetRenderSpace,a);s.targetVector=r;const o=new Array,n=new Array;for(let c=0;c<e.numActiveFaces;c++)Nt(Le,e.viewshedViewMatrices[c],a),o.push(...Le),Da(e.viewshedProjectionMatrices[c],Le,Ht),n.push(...Ht);return s.viewMatrices=o,s.projectionMatrices=n,s.volumeOffset=((d=this.selectedViewshed)==null?void 0:d.call(this))===i.viewshed?Ta(i,this.view,t.eye):0,s}get test(){return{viewsheds:this._viewsheds,shadowMap:this._shadowMap,viewshedsInView:this._viewshedsInView}}};function Sa(i,t){const e=p();return P(e,i,t)}function Da(i,t,e){const s=G(.5,.5,.5);return Ve(e,s),as(e,e,s),W(e,e,i),W(e,e,t),e}function Oa(i,t){const e=ss(t.observerRenderSpace,t.farDistanceRenderSpace);return!!i.ready&&i.frustum.intersectsSphere(e)}function Ta(i,t,e){if(i==null)return 0;const{observerRenderSpace:s,targetRenderSpace:a}=i,r=pt(e,s)>pt(e,a)?i.observer:i.target;return t.pixelSizeAt(r)}l([u()],k.prototype,"selectedViewshed",void 0),l([u()],k.prototype,"isDecoration",void 0),l([u()],k.prototype,"shadowMap",null),l([u()],k.prototype,"hasViewsheds",null),l([u()],k.prototype,"_contentPixelRatio",null),l([u()],k.prototype,"_viewshedsInView",null),l([u()],k.prototype,"consumes",void 0),l([u()],k.prototype,"produces",void 0),k=l([se("esri.views.3d.webgl-engine.lib.Viewshed")],k);const $a=p(),Le=S(),Ht=S();let E=class extends gs(be){constructor(i){super(i),this.type="viewshed-view-3d",this.analysis=null,this.tool=null,this._selectedViewshed=null,this.viewshedComputedDataHandles=null,this.userOperation=null,this._viewshedRenderer=null,this._intersector=null}get selectedViewshed(){return this._selectedViewshed}set selectedViewshed(i){this._unselectOtherViewsheds(i),this._selectedViewshed=i}get selectedViewshedComputedData(){var i;return(i=this.tool)==null?void 0:i.selectedViewshedComputedData}get _isDecoration(){return!this.parent}initialize(){const i=this.view;this._viewshedRenderer=new k({view:i,selectedViewshed:()=>{var t;return this.selectedViewshed??((t=this.tool)==null?void 0:t.stagedViewshed)},isDecoration:this._isDecoration}),this._intersector=new rs(this.view.state.viewingMode),this._intersector.options.hud=!1,this._intersector.options.store=os.MIN,this.viewshedComputedDataHandles=Xe(()=>this.analysis.viewsheds,t=>{const e=new g({renderCoordsHelper:i.renderCoordsHelper,viewshed:t}),s=Symbol();return this.addHandles([M(()=>{var a;return{valid:e.valid,canProject:ps((a=e.observer)==null?void 0:a.spatialReference,this.view.spatialReference)||vs()}},({valid:a,canProject:r},o)=>{this.visible&&(a&&r?this._addViewshedsToRenderer(e):o!=null&&o.valid&&(o!=null&&o.canProject)&&this._removeViewshedsFromRenderer(e),r||Ds(this.analysis,e.observer.spatialReference,us.getLogger(this)))},x),...this._createFeatureReferenceHandles(e)],s),{viewshedComputedData:e,remove:()=>{this.removeHandles(s),this._removeViewshedsFromRenderer(e),e.destroy()}}}),this._analysisVisualization=new re({view:i,analysisViewData:this,isDecoration:this._isDecoration}),this.addHandles([M(()=>this.visible,t=>{const e=this.viewshedComputedDataHandles;if(e==null)return;t||(this.selectedViewshed=null);const s=e.map(a=>a.viewshedComputedData).filter(a=>a.valid).toArray();t?this._addViewshedsToRenderer(s):this._removeViewshedsFromRenderer(s)}),M(()=>i.renderCoordsHelper,t=>{var e;(e=this.viewshedComputedDataHandles)==null||e.forEach(({viewshedComputedData:s})=>s.renderCoordsHelper=t)}),_s(this,O),ge(()=>this.interactive,()=>{this._unselectOtherViewsheds(this.selectedViewshed)},de)])}destroy(){this.userOperation=Be(this.userOperation),Vs(this),this._analysisVisualization=C(this._analysisVisualization);const i=this.viewshedComputedDataHandles;i!=null&&this._removeViewshedsFromRenderer(i.map(t=>t.viewshedComputedData).toArray())}_createFeatureReferenceHandles(i){const{view:t}=this;return[M(()=>[t.state.camera,t.slice.plane,i.viewshed.observer,i.targetRenderSpace,i.verticalFieldOfView,i.horizontalFieldOfView,i.feature],()=>{this._updateObserverFromFeature(t,i)},x),this._createElevationUpdateHandle(i),ge(()=>i.needUpdateByFeature,()=>{this._updateObserverFromFeature(t,i),i.needUpdateByFeature=!1})]}_createElevationUpdateHandle(i){const t=(e,s)=>{const{view:a}=this,{observer:r}=i;if(r==null)return;const o=ls(r,a.spatialReference);if(o.pending!=null)return void o.pending.finally(()=>t(e,s));const n=o.geometry;n!=null&&(hs(e,s,zt,a.spatialReference),cs(zt,[n.x,n.y])&&(i.needUpdateByFeature=!0))};return this.view.elevationProvider.on("elevation-change",({extent:e,spatialReference:s})=>t(e,s))}async createViewsheds(i){await vt(this,{placementOptions:i,onToolActivated:t=>t.place("multiple")})}place(i){return vt(this,{placementOptions:i,onToolActivated:t=>t.place("single")})}_addViewshedsToRenderer(i){this._viewshedRenderer.updateViewsheds({adds:i})}_removeViewshedsFromRenderer(i){this._viewshedRenderer.updateViewsheds({removes:i})}_updateObserverFromFeature(i,t){const e=t.observerRenderSpace,s=t.targetRenderSpace,a=B(p(),e),r={observer:e,observerSurfaceNormal:null,observerAdjusted:a,observerFeatureId:ws(t.feature),target:s,targetSurfaceNormal:null,targetAdjusted:B(p(),s),targetFeatureId:null};fs(i,this._intersector,r,o=>Math.min(o,.05*t.farDistanceRenderSpace)),t.observerRenderSpaceOverride=ns(a,e)?null:a}_unselectOtherViewsheds(i){if(i!=null)for(const t of this.view.tools.items)t!==this.tool&&t instanceof O&&(t.analysisViewData.selectedViewshed=null)}get test(){}};l([u({readOnly:!0})],E.prototype,"type",void 0),l([u({constructOnly:!0,nonNullable:!0})],E.prototype,"analysis",void 0),l([u()],E.prototype,"tool",void 0),l([u()],E.prototype,"_selectedViewshed",void 0),l([u()],E.prototype,"selectedViewshed",null),l([u()],E.prototype,"selectedViewshedComputedData",null),l([u()],E.prototype,"viewshedComputedDataHandles",void 0),l([u()],E.prototype,"userOperation",void 0),l([u()],E.prototype,"_analysisVisualization",void 0),l([u()],E.prototype,"_viewshedRenderer",void 0),E=l([se("esri.views.3d.analysis.ViewshedAnalysisView3D")],E);const rr=E,zt=ds(),xa=Object.freeze(Object.defineProperty({__proto__:null,ViewshedPassParameters:Ze,build:ei},Symbol.toStringTag,{value:"Module"}));export{rr as default};
