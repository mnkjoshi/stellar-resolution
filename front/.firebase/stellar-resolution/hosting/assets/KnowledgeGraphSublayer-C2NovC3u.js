const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/lclayout-BKmmdaIb.js","assets/_commonjsHelpers-DCkdB7M8.js"])))=>i.map(i=>d[i]);
import{bI as mt,b1 as ft,fw as X,gm as Nt,s as ee,gf as $t,bJ as Lt,ad as qe,_ as vt,gQ as Mt,dV as gt,c as St,bv as bt,a2 as le,cC as Dt,gM as De,gb as ie,fJ as Ie,ak as Ee,tJ as Pe,P as Tt,r as m,m as f,b as Ae,jJ as Rt,lV as de,S as fe,vO as ge,J as Ge,fe as Ct,lL as kt,lM as xt,lN as At,hb as Ot,lK as Ft,hJ as jt,hf as qt,hc as Pt,hg as Gt,vP as Ut,cf as we,gO as ye,lP as Ht,o3 as zt,vQ as Ue,jH as Bt,fx as Qt,lQ as Jt,ai as Vt,al as Wt,a0 as Yt,b9 as B,vR as Zt,vS as Kt,vT as Xt,vj as en,vU as tn,vV as nn,hh as rn,m8 as an,m9 as sn,lW as on,vW as ln,jL as pn,jM as un,lX as dn,oH as cn,c$ as yn,sy as hn,lU as mn,ho as fn}from"./index-BCRx-hwS.js";import{i as Oe,r as gn,a as Fe,b as pe,l as bn}from"./knowledgeGraphService-CdVMNkyd.js";import{I as _e,t as Ne,_ as Y,E as be,S as je,o as Re}from"./constants-B4mRqufT.js";import{s as se}from"./GraphQueryStreaming-CxubHzTF.js";import{f as Tn}from"./FeatureStore-lqLe32Vg.js";import{L as wn}from"./QueryEngine-Co2gKJes.js";import{y as In,u as He}from"./clientSideDefaults-Do9XYXrK.js";import{L as ze}from"./utils-DKCQA0Df.js";let En=class{constructor(){this.version="",this.queryResult=new _n}},_n=class{constructor(){this.featureResult=new Nn}},Nn=class{constructor(){this.objectIdFieldName="",this.uniqueIdField=new $n,this.globalIdFieldName="",this.geohashFieldName="",this.geometryProperties=new Ln,this.geometryType=null,this.spatialReference=new mt,this.exceededTransferLimit=!1,this.hasZ=!1,this.hasM=!1,this.transform=new wt,this.fields=[],this.fieldNameToAttributeIndexMap={},this.values=[],this.features=[],this.geometryFields=[]}},$n=class{constructor(){this.name="",this.isSystemMaintained=!1}},Ln=class{constructor(){this.shapeAreaFieldName="",this.shapeLengthFieldName="",this.units=""}},wt=class{constructor(){this.quantizeOriginPosition="upperLeft",this.scale=new vn,this.translate=new Mn}};class vn{constructor(){this.xScale=0,this.yScale=0,this.mScale=0,this.zScale=0}}let Mn=class{constructor(){this.xTranslate=0,this.yTranslate=0,this.mTranslate=0,this.zTranslate=0}},Sn=class{constructor(){this.name="",this.fieldType="esriFieldTypeString",this.alias="",this.sqlType="sqlTypeVarchar",this.domain="",this.defaultValue=""}},Dn=class{constructor(){this.attributes=[],this.compressedGeometry=new Ce,this.centroid=new Ce,this.aggregateGeometries=[]}},Ce=class{constructor(){this.geometryType=null,this.lengths=[],this.coords=[]}};var ce;(function(e){e.ELEMENTUID="ELEMENTUID",e.TYPENAME="TYPENAME"})(ce||(ce={}));const Rn=[ce.ELEMENTUID,ce.TYPENAME];var Be,Qe;(function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME"})(Be||(Be={})),function(e){e[e.ELEMENTUID=0]="ELEMENTUID",e[e.TYPENAME=1]="TYPENAME",e[e.FROMUID=2]="FROMUID",e[e.TOUID=3]="TOUID"}(Qe||(Qe={}));var Je,ke,xe,ue;(function(e){e[e.featureResult=0]="featureResult",e[e.countResult=1]="countResult",e[e.idsResult=2]="idsResult"})(Je||(Je={})),function(e){e[e.upperLeft=0]="upperLeft",e[e.lowerLeft=1]="lowerLeft"}(ke||(ke={})),function(e){e[e.sqlTypeBigInt=0]="sqlTypeBigInt",e[e.sqlTypeBinary=1]="sqlTypeBinary",e[e.sqlTypeBit=2]="sqlTypeBit",e[e.sqlTypeChar=3]="sqlTypeChar",e[e.sqlTypeDate=4]="sqlTypeDate",e[e.sqlTypeDecimal=5]="sqlTypeDecimal",e[e.sqlTypeDouble=6]="sqlTypeDouble",e[e.sqlTypeFloat=7]="sqlTypeFloat",e[e.sqlTypeGeometry=8]="sqlTypeGeometry",e[e.sqlTypeGUID=9]="sqlTypeGUID",e[e.sqlTypeInteger=10]="sqlTypeInteger",e[e.sqlTypeLongNVarchar=11]="sqlTypeLongNVarchar",e[e.sqlTypeLongVarbinary=12]="sqlTypeLongVarbinary",e[e.sqlTypeLongVarchar=13]="sqlTypeLongVarchar",e[e.sqlTypeNChar=14]="sqlTypeNChar",e[e.sqlTypeNVarChar=15]="sqlTypeNVarChar",e[e.sqlTypeOther=16]="sqlTypeOther",e[e.sqlTypeReal=17]="sqlTypeReal",e[e.sqlTypeSmallInt=18]="sqlTypeSmallInt",e[e.sqlTypeSqlXml=19]="sqlTypeSqlXml",e[e.sqlTypeTime=20]="sqlTypeTime",e[e.sqlTypeTimestamp=21]="sqlTypeTimestamp",e[e.sqlTypeTimestamp2=22]="sqlTypeTimestamp2",e[e.sqlTypeTinyInt=23]="sqlTypeTinyInt",e[e.sqlTypeVarbinary=24]="sqlTypeVarbinary",e[e.sqlTypeVarchar=25]="sqlTypeVarchar"}(xe||(xe={})),function(e){e[e.OID_ARRAY=0]="OID_ARRAY",e[e.GLOBALID_ARRAY=1]="GLOBALID_ARRAY",e[e.STRING_ARRAY=2]="STRING_ARRAY",e[e.IDENTIFIER_ARRAY=3]="IDENTIFIER_ARRAY"}(ue||(ue={}));function Cn(e){const t=new En;t.version=e.version;const r=e.get_query_result();if(r.results_type.value!==0)throw new Error("Got a non-feature collection type");const n=r.get_feature_result(),i=t.queryResult.featureResult;i.objectIdFieldName=n.objectid_field_name,i.exceededTransferLimit=n.exceeded_transfer_limit,i.hasM=n.has_m,i.hasZ=n.has_z,i.geometryType=Oe[n.geometry_type.value],i.globalIdFieldName=n.globalid_field_name,i.geohashFieldName=n.geohash_field_name;const a=i.uniqueIdField,s=n.unique_id_field;a.name=s.name,a.isSystemMaintained=s.isSystemMaintained;const o=i.geometryProperties,l=n.geometry_properties;o.shapeAreaFieldName=l.shapeAreaFieldName,o.shapeLengthFieldName=l.shapeLengthFieldName,o.units=l.units;const u=i.spatialReference,c=n.spatial_reference;u.wkid=c.wkid,u.latestWkid=c.latestWkid,u.vcsWkid=c.vcsWkid,u.latestVcsWkid=c.latestVcsWkid,u.wkt=c.wkt,i.transform=xn(n.transform);const p=i.fields,d=i.fieldNameToAttributeIndexMap,y=n.fields,w=y.size();for(let N=0;N<w;N++){const $=y.get(N),v=It($);p.push(v),d[v.name]=N,$.delete()}y.delete();const M=i.values,A=n.values_count();for(let N=0;N<A;N++)M.push(n.get_value_at(N));const h=i.features,E=n.features,k=E.size();if(k>0){for(const N of Rn)if(d[N]===void 0)throw new Error(`Feature collection missing required attribute: ${N}`)}for(let N=0;N<k;N++){const $=new Dn,v=E.get(N),G=$.attributes,O=v.attributes_count();for(let _=0;_<O;_++)G.push(v.get_attribute_at(_));const U=v.get_compressed_geometry();U&&($.compressedGeometry=ve(U),$.centroid=ve(v.get_centroid()));const J=$.aggregateGeometries,q=v.aggregate_geometries,K=q.size();for(let _=0;_<K;_++){const T=q.get(_),D=ve(T);J.push(D),T.delete()}q.delete(),h.push($),v.delete()}E.delete();const P=i.geometryFields,j=n.geometry_fields,S=j.size();for(let N=0;N<S;N++){const $=j.get(N),v=kn($);P.push(v),$.delete()}return j.delete(),t}function ve(e){const t=new Ce;t.geometryType=Oe[e.geometry_type.value];const r=[],n=[];for(let i=0;i<e.lengths.length;i++)r.push(e.lengths[i]);for(let i=0;i<e.coords.length;i++)n.push(e.coords[i]);return t.lengths=r,t.coords=n,t}function It(e){const t=new Sn;return t.name=e.name,t.alias=e.alias,t.fieldType=gn[e.field_type.value],t.sqlType=xe[e.sql_type.value],t.domain=e.domain,t.defaultValue=e.default_value,t}function kn(e){const t=It(e);return t.geometryType=Oe[e.geometry_type.value],t}function xn(e){const t=new wt;t.quantizeOriginPosition=ke[e.quantizeOriginPosition.value];const r=t.scale,n=e.scale;r.xScale=n.xScale,r.yScale=n.yScale,r.mScale=n.mScale,r.zScale=n.zScale;const i=t.translate,a=e.translate;return i.xTranslate=a.xTranslate,i.yTranslate=a.yTranslate,i.mTranslate=a.mTranslate,i.zTranslate=a.zTranslate,t}async function An(e){const t=[],r={generateAllSublayers:!1,namedTypeDefinitions:new Map};return e.entitiesUrl&&t.push(Ve(e.entitiesUrl).then(n=>{We(n,r)})),e.relationshipsUrl&&t.push(Ve(e.relationshipsUrl).then(n=>{We(n,r)})),await Promise.all(t),r}async function wr(e,t){t??(t=!1);const r={generateAllSublayers:t,namedTypeDefinitions:new Map};return await jn(e).then(n=>{Pn(n,r)}),r}async function Ir(e){const t=await Fe(),r=new t.MapOfObjectIdentifierSets;On(r,t,e);const n=new t.MapOfObjectIdentifierSetsEncoder;try{n.set_map_of_identifier_sets(r),n.encode();const i=n.get_encoding_result();if(i.error.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",i.error.error_message);const a=structuredClone(i.get_byte_buffer());return n.delete(),a}finally{r.delete()}}function On(e,t,r){for(const[n,i]of r.namedTypeDefinitions){if(!i.members||i.useAllData)continue;const a=i.members.keys();let s=!1,o=!0;const l=new t.ObjectIdArray,u=new t.StringArray,c=new t.GlobalIdArray,p=new t.IdentifierArray,d=new t.ObjectIdentifierSet;for(const y of a)o&&(s=!isNaN(Number(y)),o=!1),s?l.add_objectid(Number(y)):(u.add_string(y),c.add_globalid(y)),p.add_identifier(y);d.set_oid_array(l),d.set_string_array(u),d.set_globalid_array(c),d.set_identifier_array(p),l.delete(),u.delete(),c.delete(),p.delete(),e.put_identifier_set(n,d),d.delete()}return e}async function Ve(e){const t=await ft(e,{responseType:"array-buffer"});return Fn(await t.data)}async function Fn(e){const t=new(await Fe()).FeatureCollectionDecoder,r=t.decode(new Uint8Array(e));if(r.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",r.error_message);const n=t.get_feature_collection(),i=Cn(n);return t.delete(),i}async function jn(e){const t=await ft(e,{responseType:"array-buffer"}),r=await t.data;return qn(new Uint8Array(r))}async function qn(e){const t=new(await Fe()).MapOfObjectIdentifierSetsDecoder,r=t.decode(new Uint8Array(e)),n=new Map;if(r.error_code!==0)throw new ee("knowledge-graph:layer-support-utils",r.error_message);const i=t.get_map_of_identifier_sets(),a=i.keys,s=a.size();for(let o=0;o<s;o++){const l=a.get(o),u=i.query_identifier_set(l),c=[];if(u.id_array_type.value===ue.GLOBALID_ARRAY){const p=u.get_globalid_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_globalid_at(y))}else if(u.id_array_type.value===ue.IDENTIFIER_ARRAY){const p=u.get_identifier_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_identifier_at(y).toString())}else if(u.id_array_type.value===ue.STRING_ARRAY){const p=u.get_string_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_string_at(y))}else{if(u.id_array_type.value!==ue.OID_ARRAY)throw new ee("knowledge-graph:layer-support-utils","Tried to encode an unexpected ID Array type.");{const p=u.get_oid_array(),d=p.count();for(let y=0;y<d;y++)c.push(p.get_objectid_at(y).toString())}}n.set(l,c)}return t.delete(),n}function We(e,t){var n,i,a;if(!((n=e==null?void 0:e.queryResult)!=null&&n.featureResult))return t;const r=e.queryResult.featureResult.fieldNameToAttributeIndexMap;for(const s of e.queryResult.featureResult.features){const o=s.attributes[r[ce.TYPENAME]],l=X(t.namedTypeDefinitions,o,()=>({useAllData:!1,members:new Map})),u=s.attributes[r[ce.ELEMENTUID]];if(((a=(i=s.compressedGeometry)==null?void 0:i.coords)==null?void 0:a.length)>0){let c=s.compressedGeometry.lengths;s.compressedGeometry.geometryType==="esriGeometryPoint"&&(c=[]),l.members.set(u,{id:u,linkChartLocation:new Nt(c,s.compressedGeometry.coords)})}else l.members.set(u,{id:u})}return t}function Pn(e,t){for(const[r,n]of e){const i=X(t.namedTypeDefinitions,r,()=>({useAllData:!1,members:new Map}));for(const a of n)i.members.has(a)||i.members.set(a,{id:a})}return t}const Er={fetchAndConvertSerializedLinkChart:e=>An(e)};let Me=class oe{constructor(){this._featureLookup=new Map}static getInstance(){return oe.instance||(oe.instance=new oe),oe.instance}static resetInstance(){oe.instance&&(oe.instance=null)}deleteFromStore(t){t.forEach(r=>{this._featureLookup.delete(r)})}readFromStoreByList(t){const r=[];return t.forEach(n=>{const i=this.readFromStoreById(n);i&&r.push(i)}),r}readFromStoreById(t){return this._featureLookup.get(t)??null}writeToStore(t,r,n){const i=[];return t.forEach(a=>{if(!(a!=null&&a.id))return;a.properties||(a.properties=[]);let s,o=null;if(n&&a.properties[n]&&(o=$t(a.properties[n])),"originId"in a&&"destinationId"in a&&(a.properties[_e]=a.originId,a.properties[Ne]=a.destinationId),a.properties[r]=a.id,a.id&&this._featureLookup.has(a.id)&&this._featureLookup.get(a.id).attributes){const l=this._featureLookup.get(a.id),u=JSON.parse(JSON.stringify(Object.assign(l.attributes,a.properties)));n&&a.properties[n]&&(u[n]=Lt(a.properties[n])),s=new qe(o?JSON.parse(JSON.stringify(o)):l!=null&&l.geometry?JSON.parse(JSON.stringify(l.geometry)):null,u,null,a.properties[r])}else s=new qe(o?JSON.parse(JSON.stringify(o)):null,a.properties,null,a.properties[r]);this._featureLookup.set(`${a.typeName?`${a.typeName}__${a.id}`:a.id}`,s),i.push(s)}),i}},Se,I=null;function _r(){return Se||(Se=vt(()=>import("./lclayout-BKmmdaIb.js"),__vite__mapDeps([0,1])).then(e=>e.l).then(({default:e})=>e({locateFile:t=>Mt(`esri/libs/linkchartlayout/${t}`)})).then(e=>{Gn(e)}),Se)}function Gn(e){I=e}var Ye,te,Ze,$e;(function(e){e[e.None=0]="None",e[e.IsMovable=1]="IsMovable",e[e.IsGeographic=2]="IsGeographic",e[e.IsRoot=4]="IsRoot",e[e.IsOld=8]="IsOld"})(Ye||(Ye={})),function(e){e[e.Success=0]="Success",e[e.Error=1]="Error",e[e.Canceled=2]="Canceled"}(te||(te={})),function(e){e[e.Regular=0]="Regular",e[e.Curved=1]="Curved",e[e.Recursive=2]="Recursive"}(Ze||(Ze={})),function(e){e[e.right=0]="right",e[e.left=1]="left",e[e.top=2]="top",e[e.bottom=3]="bottom"}($e||($e={}));const Ke={none:0,"start-only":1,"start-and-end":2};function Un(e){const t={timeDirection:"right",timeBannerUTCOffsetInMinutes:0,eventsTicksVisualization:"start-and-end",showDurationLineForNonZeroDurationEntityEvents:!0,durationLineWidth:5,entityPositionAtDurationRatio:1,showNonZeroDurationIntervalBounds:!1,separateTimeOverlaps:!0,separateTimelineOverlaps:!0,moveFirstBends:!0,secondBendRatio:.3,lineSeparationMultiplier:1,spaceSeparatedLinesEvenly:!1,useBezierCurves:!1,separatedLineShapeRatio:0,...(e==null?void 0:e.toJSON())??{},eventsTicksVisualization:(e==null?void 0:e.eventsTicksVisualization)??"start-and-end"};return{...t,timeDirection:{value:$e[t.timeDirection]??$e.right},eventsTicksVisualization:{value:Ke[t.eventsTicksVisualization]??Ke["start-and-end"]}}}function ae(e,t,r,n,i,a){const s=r.length,o=i.length,l=Float64Array.BYTES_PER_ELEMENT,u=Uint32Array.BYTES_PER_ELEMENT,c=Uint8Array.BYTES_PER_ELEMENT,p=16,d=p+s*(c+2*l)+o*(2*u),y=I._malloc(d);try{const w=y+p-y%p,M=w+s*l,A=M+s*l,h=A+o*u,E=h+o*u,k=()=>[I.HEAPF64.subarray(w>>3,(w>>3)+s),I.HEAPF64.subarray(M>>3,(M>>3)+s),I.HEAPU32.subarray(A>>2,(A>>2)+o),I.HEAPU32.subarray(h>>2,(h>>2)+o),I.HEAPU8.subarray(E,E+s)],[P,j,S,N,$]=k();P.set(r),j.set(n),S.set(i),N.set(a),$.set(t);const v=e(s,E,w,M,o,A,h);let G=null,O=null;if(v.value===te.Success){const T=I.getLayoutLinksTypes(),D=I.getLayoutLinksVerticesEndIndices(),x=I.getLayoutLinksVertices(),R=I.countLayoutLinksVertices();!o||T&&D?R&&!x?v.value=te.Error:(G={types:new Uint8Array(I.HEAPU8.subarray(T,T+o)),vertexEndIndex:new Uint32Array(I.HEAPU32.subarray(D>>2,(D>>2)+o)),vertices:new Float64Array(I.HEAPF64.subarray(x>>3,(x>>3)+2*R))},O=I.getAuxiliaryGraphicElements()):v.value=te.Error}const[U,J,q,K,_]=k();return r.set(U),n.set(J),i.set(q),a.set(K),t.set(_),{status:v.value,links:G,graphics:O}}finally{I._free(y),I.cleanupLayout()}}const Xe=2,et=1,tt=-1;var nt,rt,it,at,st,ot,lt,pt,ut;(function(e){function t(){return I.getMinIdealEdgeLength()}function r(n,i,a,s,o,l,u=Xe,c=et,p=tt){return ae((d,y,w,M,A,h,E)=>I.applyForceDirectedLayout(n,d,y,w,M,A,h,E,u,c,p),i,a,s,o,l)}e.getMinIdealEdgeLength=t,e.apply=r})(nt||(nt={})),function(e){function t(r,n,i,a,s,o,l=Xe,u=et,c=tt){return ae((p,d,y,w,M,A,h)=>I.applyCommunityLayout(r,p,d,y,w,M,A,h,l,u,c),n,i,a,s,o)}e.apply=t}(rt||(rt={})),function(e){function t(r,n,i,a,s,o){return ae((l,u,c,p,d,y,w)=>I.applySimpleLayout(r,l,u,c,p,d,y,w),n,i,a,s,o)}e.apply=t}(it||(it={})),function(e){function t(r,n,i,a,s,o){return ae((l,u,c,p,d,y,w)=>I.applyHierarchicalLayout(r,l,u,c,p,d,y,w),n,i,a,s,o)}e.apply=t}(at||(at={})),function(e){function t(r,n,i,a,s,o){return ae((l,u,c,p,d,y,w)=>I.applyRadialTreeLayout(r,l,u,c,p,d,y,w),n,i,a,s,o)}e.apply=t}(st||(st={})),function(e){function t(r,n,i,a,s,o){return ae((l,u,c,p,d,y,w)=>I.applySmartTreeLayout(r,l,u,c,p,d,y,w),n,i,a,s,o)}e.apply=t}(ot||(ot={})),function(e){function t(r,n,i,a,s,o,l,u,c,p,d,y){return ae((w,M,A,h,E,k,P)=>{if(s.length!==w)return{value:te.Error};if(o.length!==w)return{value:te.Error};if(c.length!==E)return{value:te.Error};if(p.length!==E)return{value:te.Error};const j=Float64Array.BYTES_PER_ELEMENT,S=16,N=I._malloc(S+w*j),$=I._malloc(S+w*j),v=I._malloc(S+E*j),G=I._malloc(S+E*j),O=N+S-N%S,U=$+S-$%S,J=v+S-v%S,q=G+S-G%S;try{return I.HEAPF64.subarray(O>>3,(O>>3)+w).set(s),I.HEAPF64.subarray(U>>3,(U>>3)+w).set(o),I.HEAPF64.subarray(J>>3,(J>>3)+E).set(c),I.HEAPF64.subarray(q>>3,(q>>3)+E).set(p),I.applyChronologicalLayout(r,w,M,A,h,O,U,E,k,P,J,q,d,Un(y))}finally{I._free(N),I._free($),I._free(v),I._free(G)}},n,i,a,l,u)}e.apply=t}(lt||(lt={})),function(e){e[e.Undirected=0]="Undirected",e[e.Directed=1]="Directed",e[e.Reversed=2]="Reversed"}(pt||(pt={})),function(e){e[e.ByCC_Raw=0]="ByCC_Raw",e[e.ByCC_NormalizeGlobally=1]="ByCC_NormalizeGlobally",e[e.ByCC_NormalizeByCC=2]="ByCC_NormalizeByCC"}(ut||(ut={}));gt()({none:"none",startAndEnd:"start-and-end",startOnly:"start-only"});gt()({absoluteValue:"absolute-value",multiplier:"multiplier"});const Hn=new Map([["basic-grid","basic-grid"],["geographic-organic-standard","geographic-organic-standard"],["hierarchical-bottom-to-top","hierarchical-bottom-to-top"],["hierarchical-top-to-bottom","hierarchical-bottom-to-top"],["organic-community","organic-community"],["organic-fusiform","organic-standard"],["organic-leaf-circle","organic-standard"],["organic-standard","organic-standard"],["radial-node-centric","radial-root-centric"],["radial-root-centric","radial-root-centric"],["tree-bottom-to-top","tree-left-to-right"],["tree-left-to-right","tree-left-to-right"],["tree-right-to-left","tree-left-to-right"],["tree-top-to-bottom","tree-left-to-right"],["chronological-mono-timeline","chronological-mono-timeline"],["chronological-multi-timeline","chronological-multi-timeline"]]);function zn(e,t){var n,i;const r=new Map;if((n=t.dataModel)!=null&&n.relationshipTypes)for(const a of t.dataModel.relationshipTypes)a.name&&r.set(a.name,[]);for(const a of e)r.has(a.typeName)&&((i=r.get(a.typeName))==null||i.push(a.id));return r}async function Nr(e,t,r){const n=[],i=zn(e,t),a={},s=[];for(const[c,p]of i){if(p.length<1)continue;const d=`${c}_ids`;a[d]=p,s.push(`MATCH (n)-[r:${c}]->(m) WHERE id(r) in $${d} RETURN id(n), labels(n)[0], id(m), labels(m)[0]`)}if(s.length===0)return[];const o=s.join(" UNION "),l=new se({openCypherQuery:o,bindParameters:a}),u=(await pe(t,l,r==null?void 0:r.requestOptions)).resultRowsStream.getReader();for(;;){const{done:c,value:p}=await u.read();if(c)break;for(const d of p)n.push({id:d[0],typeName:d[1]}),n.push({id:d[2],typeName:d[3]})}return n}const $r=e=>Hn.get(e)??"radial-root-centric";function Bn(e){if(!e.spatialReference.isWGS84)throw new ee("knowledge-graph:layer-support-utils","The utilsExtentToInBoundsRings function only supports WGS84 spatial references.");return e.clone().normalize().map(t=>[[t.xmin,t.ymin],[t.xmin,t.ymax],[t.xmax,t.ymax],[t.xmax,t.ymin],[t.xmin,t.ymin]])}let W=class extends St{constructor(e){var r,n,i;super(e),this._processingCacheUpdatesLookup=new Map,this.knowledgeGraph=null,this.inclusionModeDefinition={generateAllSublayers:!0,namedTypeDefinitions:new Map},this.entityTypeNames=new Set,this.relationshipTypeNames=new Set,this.geographicLookup=new Map,this.sublayerCaches=new Map,this.nodeConnectionsLookup=new Map,this.relationshipConnectionsLookup=new Map,this.memberIdTypeLookup=new Map;const t=new Map;(r=e.knowledgeGraph.dataModel.entityTypes)==null||r.forEach(a=>{var s,o;a.name&&(t.set(a.name,"entity"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((s=e.inclusionModeDefinition)!=null&&s.generateAllSublayers)||this.entityTypeNames.add(a.name),(o=a.properties)==null||o.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(n=e.knowledgeGraph.dataModel.relationshipTypes)==null||n.forEach(a=>{var s,o;a.name&&(t.set(a.name,"relationship"),this._processingCacheUpdatesLookup.set(a.name,[]),e.inclusionModeDefinition&&!((s=e.inclusionModeDefinition)!=null&&s.generateAllSublayers)||this.relationshipTypeNames.add(a.name),(o=a.properties)==null||o.forEach(l=>{l.geometryType&&l.geometryType!=="esriGeometryNull"&&this.geographicLookup.set(a.name,{name:l.name??"",geometryType:l.geometryType})}))}),(i=e.inclusionModeDefinition)==null||i.namedTypeDefinitions.forEach((a,s)=>{var l,u;if(t.get(s)==="entity")this.entityTypeNames.add(s);else{if(t.get(s)!=="relationship")return bt.getLogger(this).warn(`A named type, ${s}, was in the inclusion list that wasn't in the data model and will be removed`),void((l=e.inclusionModeDefinition)==null?void 0:l.namedTypeDefinitions.delete(s));this.relationshipTypeNames.add(s)}const o=new Map;(u=a.members)==null||u.forEach(c=>{X(this.memberIdTypeLookup,c.id,()=>new Set).add(s)}),this.sublayerCaches.set(s,o)})}addToLayer(e){e.forEach(({typeName:t,id:r})=>{if(!this.inclusionModeDefinition)throw new ee("knowledge-graph:layer-data-manager","You cannot add to a layer's exclusion list if it was not created with an exclusion list originally");if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){if(this.inclusionModeDefinition.namedTypeDefinitions.has(t)){const n=this.inclusionModeDefinition.namedTypeDefinitions.get(t);n.members||(n.members=new Map),n.members.set(r,{id:r}),X(this.memberIdTypeLookup,r,()=>new Set).add(t)}}else{const n=new Map;n.set(r,{id:r}),this.inclusionModeDefinition.namedTypeDefinitions.set(t,{useAllData:!1,members:n}),X(this.memberIdTypeLookup,r,()=>new Set).add(t)}})}getById(e){return Me.getInstance().readFromStoreById(e)}async getData(e,t,r){var i,a;if(t.objectType.name&&((i=this.inclusionModeDefinition)!=null&&i.namedTypeDefinitions)&&this.inclusionModeDefinition.namedTypeDefinitions.size>0&&!this.inclusionModeDefinition.namedTypeDefinitions.has(t.objectType.name))return[];let n;if(n=e||new le({where:"1=1",outFields:["*"]}),t.parentCompositeLayer.type==="link-chart"){const s=t.parentCompositeLayer,o=this._processingCacheUpdatesLookup.get(t.objectType.name??""),l=n.outFields;l&&l.length===1&&l[0]===Y&&n.where==="1=1"||await Promise.all(o??[]);const u=this.sublayerCaches.has(t.objectType.name??"")?Array.from((a=this.sublayerCaches.get(t.objectType.name))==null?void 0:a.values()):[],c=[];return u.forEach(p=>{if(this.relationshipTypeNames.has(t.objectType.name)){p.geometry=s.relationshipLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const d=this.memberIdTypeLookup.get(p.attributes[_e]),y=this.memberIdTypeLookup.get(p.attributes[Ne]),w=this._isEndEntitySpatial(d,p,_e),M=this._isEndEntitySpatial(y,p,Ne);p.attributes[be]=Number(w&&M)}else{p.geometry=s.entityLinkChartDiagramLookup.get(p.attributes[t.objectIdField]);const d=this.geographicLookup.get(t.objectType.name);d&&p.attributes[d.name]?p.attributes[be]=1:p.attributes[be]=0}p.attributes[je]=p.geometry,c.push(p)}),c}return this.retrieveDataFromService(n,t,r)}async getConnectedRecordIds(e,t,r){const n=[];let i="";const a=this._getNamedTypeIdMapFromNodeIds(e);if(t&&(t==null?void 0:t.length)!==0){for(const c of t)i=i+c+"|";i=i.slice(0,-1)}const s={},o=[];for(const[c,p]of a){const d=`${c}_ids`;s[d]=p,t&&(t==null?void 0:t.length)!==0?o.push(`MATCH (n:${c}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r:${i}]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`):o.push(`MATCH (n:${c}) WHERE id(n) IN $${d} WITH n MATCH (n)-[r]-(m) RETURN id(r), type(r), id(m), labels(m)[0]`)}if(!o.length)return n;const l=o.join(" UNION "),u=(await pe(this.knowledgeGraph,new se({openCypherQuery:l,bindParameters:s}),{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:c,value:p}=await u.read();if(c)break;for(let d=0;d<p.length;d++){const y=p[d];n.push({id:y[0],typeName:y[1]}),n.push({id:y[2],typeName:y[3]})}}return n}async getRelationshipsBetweenNodes(e,t,r){const n=this._getNamedTypeIdMapFromNodeIds(e);if(n.size===0)return[];const i={relationshipExclusionIds:t,possibleConnectionEntityIds:e},a=[];for(const[u,c]of n.entries()){const p=`${u}_ids`;i[p]=c,a.push(`MATCH (n:${u}) WHERE id(n) IN $${p} WITH n MATCH (n)-[r]->(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const s=a.join(" UNION "),o=[],l=(await pe(this.knowledgeGraph,new se({openCypherQuery:s,bindParameters:i}),{signal:r==null?void 0:r.signal})).resultRowsStream.getReader();for(;;){const{done:u,value:c}=await l.read();if(u)break;for(let p=0;p<c.length;p++){const d=c[p];o.push({id:d[0],typeName:d[1]})}}return o}async getRelationshipsFromNodes(e,t,r,n){const i=this._getNamedTypeIdMapFromNodeIds(e);if(i.size===0||t.length===0)return[];const a={relationshipExclusionIds:r,possibleConnectionEntityIds:t},s=[];for(const[p,d]of i.entries()){const y=`${p}_ids`;a[y]=d,s.push(`MATCH (n:${p}) WHERE id(n) IN $${y} WITH n MATCH (n)-[r]-(m) WHERE id(m) IN $possibleConnectionEntityIds AND NOT id(r) IN $relationshipExclusionIds RETURN id(r), type(r)`)}const o=s.join(" UNION "),l=new Map,u=(await pe(this.knowledgeGraph,new se({openCypherQuery:o,bindParameters:a}),{signal:n==null?void 0:n.signal})).resultRowsStream.getReader();for(;;){const{done:p,value:d}=await u.read();if(p)break;for(let y=0;y<d.length;y++){const w=d[y];let M=l.get(w[1]);M||(M=new Set,l.set(w[1],M)),M.add(w[0])}}const c=[];for(const[p,d]of l)for(const y of d)c.push({id:y,typeName:p});return c}async refreshCacheContent(e,t,r,n=!0,i){var u,c,p,d,y,w,M,A;const a=Me.getInstance(),s=[],o=new Map,l=new Map;(u=this.knowledgeGraph.dataModel.entityTypes)==null||u.forEach(h=>{h.name&&l.set(h.name,h)}),(c=this.knowledgeGraph.dataModel.relationshipTypes)==null||c.forEach(h=>{h.name&&l.set(h.name,h)}),e||this.inclusionModeDefinition?e?e.forEach(h=>{var E;if(this.memberIdTypeLookup.has(h))for(const k of this.memberIdTypeLookup.get(h))o.has(k)?(E=o.get(k))==null||E.push(h):o.set(k,[h])}):(d=(p=this.inclusionModeDefinition)==null?void 0:p.namedTypeDefinitions)==null||d.forEach((h,E)=>{h.useAllData?o.set(E,null):h.members&&h.members.forEach(k=>{var P;o.has(E)&&o.get(E)!==null?(P=o.get(E))==null||P.push(k.id):o.set(E,[k.id])})}):((y=this.knowledgeGraph.dataModel.entityTypes)==null||y.forEach(h=>{h.name&&o.set(h.name,null)}),(w=this.knowledgeGraph.dataModel.entityTypes)==null||w.forEach(h=>{h.name&&o.set(h.name,null)}));for(const[h,E]of o){const k=new Set(E),P=new Promise((j,S)=>{(async()=>{var K,_,T,D,x,R,C,F,L;const $=new Set,v=[];let G,O="",U=!1;if(t||((_=(K=l.get(h))==null?void 0:K.properties)==null||_.forEach(g=>{g.name&&$.add(g.name)})),r&&this.geographicLookup.has(h)){const g=(T=this.geographicLookup.get(h))==null?void 0:T.name;g&&$.add(g)}if(this.entityTypeNames.has(h))O=`MATCH (n:${h}) ${E?"WHERE id(n) IN $ids ":""}return ID(n)`,$.forEach(g=>{O+=`, n.${g}`,v.push(g)});else{if(!this.relationshipTypeNames.has(h))throw new ee("knowledge-graph:layer-data-manager",`The graph type of ${h} could not be determined. Was this type set in the KG data model and inclusion definition?`);U=!0,O=`MATCH ()-[n:${h}]->() ${E?"WHERE id(n) IN $ids ":""}return ID(n), id(startNode(n)), id(endNode(n))`,$.forEach(g=>{O+=`, n.${g}`,v.push(g)})}G=new se(E?{openCypherQuery:O,bindParameters:{ids:E}}:{openCypherQuery:O});const J=(await pe(this.knowledgeGraph,G,{signal:i==null?void 0:i.signal})).resultRowsStream.getReader();for(;;){const{done:g,value:ne}=await J.read();if(g)break;const V=[];for(let Z=0;Z<ne.length;Z++){const re=ne[Z];let H=0,Te=0;const z={properties:{}};for(z.id=re[H],H++,Te++,U&&(z.originId=re[H],H++,Te++,z.destinationId=re[H],H++,Te++,X(this.nodeConnectionsLookup,z.originId,()=>new Set).add(z.id),X(this.nodeConnectionsLookup,z.destinationId,()=>new Set).add(z.id),X(this.relationshipConnectionsLookup,z.id,()=>[z.originId,z.destinationId]));H<re.length;H++)z.properties[v[H-Te]]=re[H];k.delete(z.id),V.push(z)}const _t=a.writeToStore(V,Y,(D=this.geographicLookup.get(h))==null?void 0:D.name);this.sublayerCaches.has(h)||this.sublayerCaches.set(h,new Map),n&&!((x=this.inclusionModeDefinition)!=null&&x.namedTypeDefinitions.has(h))&&((R=this.inclusionModeDefinition)==null||R.namedTypeDefinitions.set(h,{useAllData:!1,members:new Map})),n&&!((C=this.inclusionModeDefinition)!=null&&C.namedTypeDefinitions.get(h).members)&&(this.inclusionModeDefinition.namedTypeDefinitions.get(h).members=new Map);const Le=this.sublayerCaches.get(h);_t.forEach(Z=>{var re,H;Le==null||Le.set(Z.attributes[Y],Z),n&&!((re=this.inclusionModeDefinition)!=null&&re.namedTypeDefinitions.get(h).members.has(Z.attributes[Y]))&&((H=this.inclusionModeDefinition)==null||H.namedTypeDefinitions.get(h).members.set(Z.attributes[Y],{id:Z.attributes[Y]}),X(this.memberIdTypeLookup,Z.attributes[Y],()=>new Set).add(h))})}const q=(F=this.inclusionModeDefinition)==null?void 0:F.namedTypeDefinitions.get(h);if(q)for(const g of k)(L=q.members)==null||L.delete(g)})().then(()=>{j(null)}).catch($=>{$.name==="AbortError"?j(null):S($)})});s.push(P),(M=this._processingCacheUpdatesLookup.get(h))==null||M.push(P)}if(await Promise.all(s),(A=i==null?void 0:i.signal)==null?void 0:A.aborted)throw Dt()}removeFromLayer(e){var n,i,a;const t=new Set,r=new Set(e.map(s=>s.id));for(const s of e)t.add(s.typeName),((n=this.memberIdTypeLookup.get(s.id))==null?void 0:n.size)===1?this.memberIdTypeLookup.delete(s.id):(i=this.memberIdTypeLookup.get(s.id))==null||i.delete(s.typeName),(a=this.inclusionModeDefinition)==null||a.namedTypeDefinitions.forEach((o,l)=>{var u;l===s.typeName&&((u=o.members)!=null&&u.has(s.id))&&o.members.delete(s.id)});t.forEach(s=>{var o;(o=this.sublayerCaches.get(s))==null||o.forEach((l,u)=>{var c;r.has(u)&&((c=this.sublayerCaches.get(s))==null||c.delete(u))})})}async retrieveDataFromService(e,t,r){var w,M,A,h,E,k,P,j,S,N,$,v,G,O,U,J,q,K;const n=Me.getInstance(),i=new Set,a=[];let s,o="",l=[];const u=t.graphType==="relationship",c=(A=(M=(w=this.inclusionModeDefinition)==null?void 0:w.namedTypeDefinitions)==null?void 0:M.get(t.objectType.name))==null?void 0:A.useAllData,p=t.parentCompositeLayer.sublayerIdsCache.get(t.objectType.name);let d=!c&&p?Array.from(p).sort():null;if((k=(E=(h=this.inclusionModeDefinition)==null?void 0:h.namedTypeDefinitions)==null?void 0:E.get(t.objectType.name))!=null&&k.useAllData)(S=(j=(P=this.inclusionModeDefinition)==null?void 0:P.namedTypeDefinitions)==null?void 0:j.get(t.objectType.name))!=null&&S.useAllData&&e.objectIds!=null&&(d=e.objectIds);else if(e.objectIds!=null&&d&&d.length>0){const _=e.objectIds;e.objectIds=d.filter(T=>_.includes(T))}else if(e.objectIds!=null)d=e.objectIds;else{if((N=this.inclusionModeDefinition)!=null&&N.namedTypeDefinitions.has(t.objectType.name)&&(!(($=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))!=null&&$.members)||((G=(v=this.inclusionModeDefinition.namedTypeDefinitions.get(t.objectType.name))==null?void 0:v.members)==null?void 0:G.size)<1))return e.objectIds=[],[];e.objectIds=d}if(e.outFields!=null){const _=e.outFields;_.includes("*")?t.fields.forEach(T=>{i.add(T.name)}):_.forEach(T=>{T!==Y&&T!==t.geometryFieldName&&i.add(T)})}if(e.geometry!=null){const _=e.geometry;let T;const D=t.parentCompositeLayer.dataManager.knowledgeGraph.serviceDefinition,x=D==null?void 0:D.spatialReference,R=(O=D==null?void 0:D.serviceCapabilities)==null?void 0:O.geometryCapabilities;let C=R==null?void 0:R.geometryMaxBoundingRectangleSizeX,F=R==null?void 0:R.geometryMaxBoundingRectangleSizeY;if(_.type==="point"){let L=_;(U=L.spatialReference)!=null&&U.isWGS84||(await De(L.spatialReference,ie),L=Ie(L,ie)),T=new Ee({spatialReference:ie,xmin:L.x-1e-4,ymin:L.y-1e-4,xmax:L.x+1e-4,ymax:L.y+1e-4})}else(J=_==null?void 0:_.extent)!=null&&J.spatialReference&&!((q=_.spatialReference)!=null&&q.isWGS84)?(await De(_.extent.spatialReference,ie),T=Ie(_.extent,ie)):T=_.extent;if(C&&F&&x){if(x.wkid!==4326){const L=new Ee({spatialReference:x,xmax:C,ymax:F}),g=Ie(L,ie);C=g.xmax,F=g.ymax}if(T.xmax-T.xmin>C)throw new ee("knowledge-graph:layer-data-manager",`Extent x bounds should be within ${C}° latitude, limit exceeded`);if(T.ymax-T.ymin>F)throw new ee("knowledge-graph:layer-data-manager",`Extent y bounds should be within ${F}° longitude, limit exceeded`)}if(e.where!=null&&e.where!=="1=1"){const L=await Pe(e.where.toUpperCase(),t.fieldsIndex);t.fields.forEach(g=>{L.fieldNames.includes(g.name)&&i.add(g.name)})}o=u?`Match ()-[n:${t.objectType.name}]->() WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n), id(startNode(r)), id(endNode(r))`:`Match (n:${t.objectType.name}) WHERE esri.graph.ST_Intersects($param_filter_geom, n.${t.geometryFieldName}) return ID(n)`,t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(L=>{o+=`, n.${L}`,a.push(L)}),s=new se({openCypherQuery:o,bindParameters:{param_filter_geom:new Tt({rings:Bn(T)})}})}else{let _="";if(e.where!=null&&e.where!=="1=1"){const x=await Pe(e.where,t.fieldsIndex);t.fields.forEach(g=>{x.fieldNames.includes(g.name)&&i.add(g.name)});const R=new Set(["column-reference","string","number","binary-expression"]),C=new Set(["=","<","<=","<>",">",">=","AND","OR","LIKE"]);let F=!1;const L=g=>{if(g.type==="column-reference")return`n.${g.column}`;if(g.type==="string")return`'${g.value}'`;if(g.type==="number")return`${g.value}`;if(g.type==="binary-expression"&&R.has(g.left.type)&&R.has(g.right.type)&&C.has(g.operator))return`${L(g.left)} ${g.operator} ${L(g.right)}`;if(g.type==="binary-expression"&&g.operator==="LIKE"){let ne="";if(g.left.type==="function"&&g.left.args.value[0].type==="column-reference")ne+=`lower(n.${g.left.args.value[0].column})`;else{if(g.left.type!=="column-reference")return F=!0,"";ne+=`lower(n.${g.left.column})`}if(ne+=" CONTAINS (",g.right.type!=="string")return F=!0,"";{let V=g.right.value;V.charAt(0)==="%"&&(V=V.slice(1)),V.charAt(V.length-1)==="%"&&(V=V.slice(0,-1)),ne+=`'${V.toLowerCase()}')`}return ne}return F=!0,""};_=L(x.parseTree),F&&(_="")}let T="";T=u?`Match ()-[n:${t.objectType.name}]->()`:`Match (n:${t.objectType.name})`;let D=!1;d&&(D=!0,T+=" WHERE ID(n) IN $ids"),_&&(T+=D?" AND":" WHERE",T+=` ${_}`),T+=" return ID(n)",u&&(T+=", id(startNode(n)), id(endNode(n))"),e.returnGeometry&&t.geometryFieldName&&i.add(t.geometryFieldName),i.forEach(x=>{T+=`, n.${x}`,a.push(x)}),s=new se(d?{openCypherQuery:T,bindParameters:{ids:d}}:{openCypherQuery:T})}const y=(await pe(t.parentCompositeLayer.dataManager.knowledgeGraph,s,r)).resultRowsStream.getReader();for(;;){const{done:_,value:T}=await y.read();if(_)break;const D=[];for(let x=0;x<T.length;x++){const R=T[x];let C=0,F=0;const L={properties:{}};for(L.id=R[C],C++,F++,u&&(L.originId=R[C],C++,F++,L.destinationId=R[C],C++,F++);C<R.length;C++)L.properties[a[C-F]]=R[C];D.push(L)}l=l.concat(n.writeToStore(D,Y,(K=t.parentCompositeLayer.dataManager.geographicLookup.get(t.objectType.name))==null?void 0:K.name))}return l}_isEndEntitySpatial(e,t,r){var n;for(const i of e??[])if(this.entityTypeNames.has(i)){const a=this.geographicLookup.get(i),s=a&&((n=this.sublayerCaches.get(i))==null?void 0:n.get(t.attributes[r]));if(a&&(s!=null&&s.attributes[a.name]))return!0}return!1}_getNamedTypeIdMapFromNodeIds(e){const t=new Map;return e.forEach(r=>{var n;if(this.memberIdTypeLookup.has(r))for(const i of this.memberIdTypeLookup.get(r)){if(!this.entityTypeNames.has(i))return;t.has(i)?(n=t.get(i))==null||n.push(r):t.set(i,[r])}}),t}};m([f()],W.prototype,"knowledgeGraph",void 0),m([f()],W.prototype,"inclusionModeDefinition",void 0),m([f()],W.prototype,"entityTypeNames",void 0),m([f()],W.prototype,"relationshipTypeNames",void 0),m([f()],W.prototype,"geographicLookup",void 0),m([f()],W.prototype,"sublayerCaches",void 0),m([f()],W.prototype,"nodeConnectionsLookup",void 0),m([f()],W.prototype,"relationshipConnectionsLookup",void 0),m([f()],W.prototype,"memberIdTypeLookup",void 0),W=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphLayerDataManager")],W);const dt=Rt(),Qn=e=>{let t=class extends e{constructor(){super(...arguments),this.fields=[],this.fieldsIndex=null}};return m([f(dt.fields)],t.prototype,"fields",void 0),m([f(dt.fieldsIndex)],t.prototype,"fieldsIndex",void 0),t=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphSublayerBase")],t),t},Jn={initializeLayersFromClientData:async(e,t,r)=>{if(t||(t=[...e.layers,...e.tables].map(a=>a.graphTypeName)),(t==null?void 0:t.length)===0)return;const n=new Map;for(const a of t)n.set(a,ct(e,a));const i=await bn(e.dataManager.knowledgeGraph,Array.from(n.values()),{requestOptions:{signal:r==null?void 0:r.signal}});for(const a of[...e.layers,...e.tables]){const s=a.objectType.name;if(s==null)continue;const o=i.get(ct(e,s));if(o){const l=JSON.parse(o);l===null||typeof l!="object"||l.hasOwnProperty("showLabels")||(l.showLabels=!1),a.read(l,{origin:"service"})}}}},ct=(e,t)=>e.type==="knowledge-graph"?`${t}/Map`:`${t}/LinkChart/LinkChartSubLayer`;async function Lr(e,t,r){return Jn.initializeLayersFromClientData(e,t,r)}const yt=["#4a0932","#b31515","#18382e","#a64f1b","#102432","#8c213f","#ed9310","#2c6954","#144d59","#ffc730","#75351e","#454f4b","#78b1c2","#191921","#8f8f82","#9be0c0","#dbb658","#87b051","#11495c","#c43541","#9c5596","#44498b","#ad9d63","#86afb3","#5c98ca","#b0bfa2","#73241f","#b86b53","#d9d78c","#3e756d","#f260a1","#a0d17d","#c27c30","#eb82eb","#ffdf3c","#ffb259","#ab52b3","#3cccb4","#0095ba","#d92b30"],Vn="#8f8f82";function Wn(e){return e<0||e>=yt.length?new Ge(Vn):new Ge(yt[e])}function Yn(e){const t=e.toArray();return new Ct({data:{type:"CIMSymbolReference",symbol:{type:"CIMLineSymbol",symbolLayers:[{type:"CIMSolidStroke",enable:!0,style:"solid",width:.75,color:t},{type:"CIMVectorMarker",enable:!0,size:6,markerPlacement:{type:"CIMMarkerPlacementOnLine",angleToLine:!0,relativeTo:"LineMiddle"},frame:{xmin:-10,ymin:-5,xmax:0,ymax:5},markerGraphics:[{type:"CIMMarkerGraphic",geometry:{rings:[[[-12,-3.47],[-12,3.6],[1.96,-.03],[-12,-3.47]]]},symbol:{type:"CIMPolygonSymbol",symbolLayers:[{type:"CIMSolidFill",enable:!0,color:t}]}}]}]}}})}function Zn(e){let t="ESRI__ID",r=4;for(const n of e)if(n.name){if(n.name.toLowerCase()==="name"){t=n.name;break}n.name.toLowerCase().includes("name")?(t=n.name,r=2):n.fieldType==="esriFieldTypeString"&&r>3&&(t=n.name,r=3)}return t}function Kn(e,t,r){const n={color:[80,80,80],haloColor:[255,255,255],haloSize:.7,font:{size:10,weight:"normal"}},i=new de({labelExpressionInfo:new ge({expression:r==="ESRI__ID"?`${t}`:`$feature.${r}`}),labelPlacement:"above-center",symbol:new fe(n)}),a=new de({labelExpressionInfo:new ge({expression:`'${t}' + IIf($feature.ESRI__AggregationCount>1, ' (' + $feature.ESRI__AggregationCount + ')', '')`}),labelPlacement:"center-along",labelPosition:"parallel",repeatLabel:!1,symbol:new fe({...n,yoffset:"12px"})});return e==="entity"?[i]:[a]}function Xn(e,t,r){const n={color:[255,255,255],haloColor:[0,0,0],haloSize:.7,font:{size:10,weight:"bold"}},i=r==="ESRI__ID"?`${e}`:`$feature.${r}`;return t==="point"?[new de({labelExpressionInfo:new ge({expression:i}),labelPlacement:"above-center",symbol:new fe(n)})]:t==="polyline"?[new de({labelExpressionInfo:new ge({expression:i}),labelPlacement:"center-along",repeatLabel:!0,symbol:new fe(n)})]:t==="polygon"?[new de({labelExpressionInfo:new ge({expression:i}),labelPlacement:"always-horizontal",symbol:new fe(n)})]:null}function Q(e){if(!e.json)return e;e.json.write=ht(e.json.write);const t=e.json.origins;if(!t)return e;let r;for(r in t){const n=t[r];n&&(n.write=ht(n.write))}return e}function ht(e){return typeof e=="object"&&e?(e.enabled!==!1&&(e.overridePolicy=er(e)),e):e===!0?he():e}function er(e){const{target:t,writer:r,overridePolicy:n,...i}=e;return function(a,s){const o=Et.call(this,a,s);return o.enabled?{...i,...o}:o}}function he(){return{overridePolicy:Et}}function Et(e,t){const r=!!this.geometryType;let n={enabled:r};return r&&(n={...n,...me.call(this,e,t)}),n}function me(e,t){return{ignoreOrigin:this.originIdOf(t)>fn.DEFAULTS}}let b=class extends Qn(kt(xt(At(Ot(Ft(jt(qt(Pt(Gt(Yt)))))))))){constructor(e){super(e),this.blendMode="normal",this.capabilities=In(!1,!0),this.charts=null,this.definitionExpression=null,this.displayField="",this.displayFilterEnabled=!0,this.displayFilterInfo=null,this.effect=null,this.elevationInfo=null,this.featureEffect=null,this.graphType=null,this.labelsVisible=!0,this.layerType=null,this.legendEnabled=!0,this.maxScale=0,this.minScale=0,this.objectIdField=Y,this.objectType=null,this.opacity=1,this.orderBy=null,this.parent=null,this.parentCompositeLayer=null,this.persistenceEnabled=!0,this.popupEnabled=!0,this.popupTemplate=null,this.refreshInterval=0,this.source={openPorts:()=>this.load().then(()=>{const t=new MessageChannel;return new Ut(t.port1,{channel:t,client:{queryFeatures:(r,n={})=>{const i=le.fromJSON(r);return this.queryFeaturesJSON(i,n)}}}),[t.port2]})},this.type="knowledge-graph-sublayer",this.useViewTime=!0,this.visible=!0}get userHasUpdateItemPrivileges(){var e;return!!((e=this.parent)!=null&&e.userHasUpdateItemPrivileges)}get defaultPopupTemplate(){return this.createPopupTemplate()}set featureReduction(e){const t=this._normalizeFeatureReduction(e);this._set("featureReduction",t)}get fields(){var t,r;const e=[];return(r=(t=this.objectType)==null?void 0:t.properties)==null||r.forEach(n=>{const i=n.fieldType==="esriFieldTypeOID"?"esriFieldTypeInteger":n.fieldType;e.push(we.fromJSON({name:n.name,type:i,alias:n.alias,defaultValue:n.defaultValue,editable:n.editable,nullable:n.nullable}))}),e.push(we.fromJSON({name:this.objectIdField,type:"esriFieldTypeString",alias:this.objectIdField,editable:!1}),we.fromJSON({name:Re,type:"esriFieldTypeInteger",alias:Re,editable:!1}),we.fromJSON({name:be,type:"esriFieldTypeInteger",alias:be,editable:!1})),e}get geometryType(){var r,n,i;if(((r=this.parentCompositeLayer)==null?void 0:r.type)==="link-chart")return this.graphType==="relationship"?"polyline":"point";const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.geometryType;return t&&t!=="esriGeometryNull"?ye.fromJSON(t):null}get geometryFieldName(){var t,r,n;if(((t=this.parentCompositeLayer)==null?void 0:t.type)==="link-chart")return je;const e=(n=this.parentCompositeLayer)==null?void 0:n.dataManager.geographicLookup.get((r=this.objectType)==null?void 0:r.name);return(e==null?void 0:e.name)??null}get graphTypeName(){var e;return(e=this.objectType)==null?void 0:e.name}get hasM(){var n,i,a,s;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name,r=t?(s=(a=this.objectType)==null?void 0:a.properties)==null?void 0:s[t]:null;return(r==null?void 0:r.hasM)??!1}get hasZ(){var n,i,a,s;const e=(i=this.parentCompositeLayer)==null?void 0:i.dataManager.geographicLookup.get((n=this.objectType)==null?void 0:n.name),t=e==null?void 0:e.name,r=t?(s=(a=this.objectType)==null?void 0:a.properties)==null?void 0:s[t]:null;return(r==null?void 0:r.hasZ)??!1}set labelingInfo(e){this._set("labelingInfo",e)}get labelingInfo(){if(this._isOverridden("labelingInfo"))return this._get("labelingInfo");if(!this.objectType||!this.parentCompositeLayer||!this.graphTypeName)return null;const e=this.objectType.properties?Zn(this.objectType.properties):"ESRI__ID";return this.parentCompositeLayer.type==="link-chart"?Kn(this.graphType,this.graphTypeName,e):Xn(this.graphTypeName,this.geometryType,e)}set renderer(e){Ht(e,this.fieldsIndex),this._set("renderer",e)}get renderer(){var i,a,s,o;if(this._isOverridden("renderer"))return this._get("renderer");const e=(s=(a=(i=this.parentCompositeLayer)==null?void 0:i.dataManager)==null?void 0:a.knowledgeGraph)==null?void 0:s.dataModel,t=[...(e==null?void 0:e.entityTypes)??[],...(e==null?void 0:e.relationshipTypes)??[]].map(l=>l.name).indexOf(this.graphTypeName),r=Wn(t);if(((o=this.parentCompositeLayer)==null?void 0:o.type)==="link-chart"){if(this.graphType==="relationship")return new zt({type:"simple",symbol:Yn(r)});const l=Ue(He(ye.toJSON("point")).renderer);return ze(l.symbol,r),l}const n=Ue(He(ye.toJSON(this.geometryType)).renderer);return ze(n.symbol,r),n}get spatialReference(){var e,t,r,n;return((n=(r=(t=(e=this.parentCompositeLayer)==null?void 0:e.dataManager)==null?void 0:t.knowledgeGraph)==null?void 0:r.dataModel)==null?void 0:n.spatialReference)??mt.WGS84}set timeInfo(e){this._set("timeInfo",e)}get title(){return this._isOverridden("title")?this._get("title"):this.graphTypeName}set title(e){this._set("title",e)}writeTitle(e,t){t.title=e??"Layer"}createPopupTemplate(e){return Bt(this,e)}createQuery(){return new le({where:"1=1",outFields:["*"]})}getField(e){return this.fieldsIndex.get(e)}getFieldDomain(e,t){return null}async queryFeatures(e,t){await this.load();const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e),i=Qt.fromJSON(await n.executeQuery(r.toJSON(),t==null?void 0:t.signal));return i.features.forEach(a=>{a.sourceLayer=this}),i}async queryFeaturesJSON(e,t){await this.load();const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return await n.executeQuery(r.toJSON(),t==null?void 0:t.signal)}async queryFeatureCount(e,t){await this.load();const{resolvedQuery:r,queryEngine:n}=await this._setupQueryObjects(e);return n.executeQueryForCount(r.toJSON(),t==null?void 0:t.signal)}async queryExtent(e={},t){var o,l,u,c;await this.load();const r={...e,returnGeometry:!0},{resolvedQuery:n,queryEngine:i}=await this._setupQueryObjects(r),a=await i.executeQueryForExtent(n.toJSON(),t==null?void 0:t.signal);let s;return s=((o=a.extent)==null?void 0:o.xmin)!=null&&((l=a.extent)==null?void 0:l.xmax)!=null&&((u=a.extent)==null?void 0:u.ymin)!=null&&((c=a.extent)==null?void 0:c.ymax)!=null?new Ee(a.extent):new Ee,{count:a.count,extent:s}}async queryObjectIds(e,t){await this.load();const r=le.from(e);let n;if(this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)n=this._cachedQueryEngine;else{const i=await this.parentCompositeLayer.dataManager.getData(r,this,t);n=this.loadQueryEngine(i)}return await n.executeQueryForIds(r.toJSON(),t==null?void 0:t.signal)}loadQueryEngine(e){var n;const t=new Tn({geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ}),r=new wn({fieldsIndex:this.fieldsIndex.toJSON(),geometryType:ye.toJSON(this.geometryType),hasM:this.hasM,hasZ:this.hasZ,featureIdInfo:{type:"object-id",fieldName:this.objectIdField},spatialReference:this.spatialReference.toJSON(),timeInfo:(n=this.timeInfo)==null?void 0:n.toJSON(),featureStore:t});return r.featureStore.addMany(e),r}async refreshCachedQueryEngine(){const e=await this.parentCompositeLayer.dataManager.getData(new le({where:"1=1",outFields:[Y]}),this);this._cachedQueryEngine=this.loadQueryEngine(e)}load(e){return this.addResolvingPromise(this.parent.load(e).then(()=>Jt(this.timeInfo,this.fieldsIndex))),Promise.resolve(this)}async _setupQueryObjects(e,t){var a;const r=le.from(e),n=r.geometry;if(n&&!((a=n.spatialReference)!=null&&a.isWGS84)&&(await De(n.spatialReference,ie),r.geometry=Ie(n instanceof Tt||n instanceof Vt||n instanceof Wt?n:n.extent,ie)),this.parentCompositeLayer.type==="link-chart"&&this._cachedQueryEngine)return{resolvedQuery:r,queryEngine:this._cachedQueryEngine};const i=await this.parentCompositeLayer.dataManager.getData(r,this,t);return{resolvedQuery:r,queryEngine:this.loadQueryEngine(i)}}};function tr(e,t,r){var i,a;const n=[["ESRI__AGGREGATION_COUNT",Re],["ESRI__ORIGIN_ID",_e],["ESRI__DESTINATION_ID",Ne],["ESRI__LAYOUT_GEOMETRY",je]];try{for(const s of e)for(const[o,l]of n)s.labelExpression=(i=s.labelExpression)==null?void 0:i.replaceAll(o,l),(a=s.labelExpressionInfo)!=null&&a.expression&&(s.labelExpressionInfo.expression=s.labelExpressionInfo.expression.replaceAll(o,l))}catch(s){bt.getLogger(this).warn("Error updating labelingInfo",s)}return mn(e,t,r)}m([f(Q(B(Zt)))],b.prototype,"blendMode",void 0),m([f()],b.prototype,"capabilities",void 0),m([f({readOnly:!0})],b.prototype,"userHasUpdateItemPrivileges",null),m([f({json:{origins:{"web-scene":{write:!1}},write:he()}})],b.prototype,"charts",void 0),m([f({readOnly:!0})],b.prototype,"defaultPopupTemplate",null),m([f({type:String,json:{origins:{service:{read:!1}},name:"layerDefinition.definitionExpression",write:{ignoreOrigin:!0}}})],b.prototype,"definitionExpression",void 0),m([f()],b.prototype,"displayField",void 0),m([f(Q(B(Kt)))],b.prototype,"displayFilterEnabled",void 0),m([f(Q(B(Xt)))],b.prototype,"displayFilterInfo",void 0),m([f(Q(B(en)))],b.prototype,"effect",void 0),m([f()],b.prototype,"elevationInfo",void 0),m([f(Q(B(tn)))],b.prototype,"featureEffect",void 0),m([f(Q(B(nn)))],b.prototype,"featureReduction",null),m([f()],b.prototype,"fields",null),m([f()],b.prototype,"geometryType",null),m([f()],b.prototype,"geometryFieldName",null),m([f({type:["entity","relationship"],nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphType",void 0),m([f({type:String,nonNullable:!0,json:{write:{isRequired:!0,ignoreOrigin:!0}}})],b.prototype,"graphTypeName",null),m([f()],b.prototype,"hasM",null),m([f()],b.prototype,"hasZ",null),m([f({type:String,json:{origins:{service:{read:!1},"portal-item":{read:!1}},write:{ignoreOrigin:!0}}})],b.prototype,"id",void 0),m([f({type:Boolean,value:!0,nonNullable:!0,json:{name:"showLabels",default:!1,write:{overridePolicy(){return{enabled:!!this.geometryType,alwaysWriteDefaults:!0,ignoreOrigin:!0}}}}})],b.prototype,"labelsVisible",void 0),m([f({type:[de],json:{name:"layerDefinition.drawingInfo.labelingInfo",read:tr,write:he()}})],b.prototype,"labelingInfo",null),m([f({readOnly:!0,json:{read:!1,write:{writer(e,t){var r;switch((r=this.parentCompositeLayer)==null?void 0:r.type){case"link-chart":t.layerType="LinkChartSubLayer";break;case"knowledge-graph":t.layerType=this.geometryType?"KnowledgeGraphSubLayer":"KnowledgeGraphSubTable"}},isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"layerType",void 0),m([f(Q(B(rn)))],b.prototype,"legendEnabled",void 0),m([f(Q(B(an)))],b.prototype,"maxScale",void 0),m([f(Q(B(sn)))],b.prototype,"minScale",void 0),m([f()],b.prototype,"objectIdField",void 0),m([f()],b.prototype,"objectType",void 0),m([f(Q(B(on)))],b.prototype,"opacity",void 0),m([f(Q(B(ln)))],b.prototype,"orderBy",void 0),m([f({clonable:!1})],b.prototype,"parent",void 0),m([f()],b.prototype,"parentCompositeLayer",void 0),m([f(Q(B(pn)))],b.prototype,"popupEnabled",void 0),m([f({type:un,json:{name:"popupInfo",write:{ignoreOrigin:!0}}})],b.prototype,"popupTemplate",void 0),m([f({type:Number,json:{write:{overridePolicy:me}}})],b.prototype,"refreshInterval",void 0),m([f({types:dn,json:{name:"layerDefinition.drawingInfo.renderer",write:he()}})],b.prototype,"renderer",null),m([f()],b.prototype,"source",void 0),m([f()],b.prototype,"spatialReference",null),m([f({type:cn,json:{name:"layerDefinition.timeInfo",write:{overridePolicy:me},origins:{"web-document":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:me}},"portal-item":{name:"layerDefinition.timeInfo",read:!0,write:{overridePolicy:me}}}}})],b.prototype,"timeInfo",null),m([f({type:String,json:{write:{isRequired:!0,ignoreOrigin:!0,writerEnsuresNonNull:!0}}})],b.prototype,"title",null),m([yn("title")],b.prototype,"writeTitle",null),m([f({json:{read:!1}})],b.prototype,"type",void 0),m([f(Q(B(hn)))],b.prototype,"useViewTime",void 0),m([f({type:Boolean,json:{name:"visibility",write:he()}})],b.prototype,"visible",void 0),b=m([Ae("esri.layers.knowledgeGraph.KnowledgeGraphSublayer")],b);export{rt as A,$r as C,Er as D,W as E,b as I,at as P,st as _,lt as a,it as b,ot as c,Ye as d,_r as e,te as f,Nr as g,Ir as h,Lr as i,wr as m,Me as o,Ze as u,nt as v};
